
<!doctypehtml><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>RamNotes</title><style>:root{--bg:#0b1020;--bg-2:#0e1530;--surface:rgba(255,255,255,0.06);--surface-2:rgba(255,255,255,0.10);--text:#eaf2ff;--muted:#9fb0c9;--accent:#22d3ee;--accent-2:#a78bfa;--danger:#ef4444;--radius:14px;--shadow:0 12px 30px rgba(0,0,0,.35);--blur:14px}body.light{--bg:#f3f6fb;--bg-2:#eaf1ff;--surface:rgba(0,0,0,0.12);--surface-2:rgba(0,0,0,0.22);--text:#0f172a;--muted:#334155;--accent:#2563eb;--accent-2:#7c3aed}body.hacker{--bg:#000;--bg-2:#020202;--text:#e2ffe9;--muted:#86efac;--accent:#00ff99;--accent-2:#22d3ee}body.beach{--bg:#0b1320;--bg-2:#0d1b2a;--accent:#ffd166;--accent-2:#06d6a0}body.nature{--bg:#0e1a14;--bg-2:#0b2418;--accent:#22c55e;--accent-2:#84cc16}*{box-sizing:border-box}body,html{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);display:flex;min-height:100vh}:root{--sidebar-w:280px}.sidebar{width:var(--sidebar-w);padding:16px;border-right:1px solid var(--surface-2);background:var(--bg)}.sidebar h2{margin:0 0 10px;font-size:1rem;color:var(--accent)}.workspace{margin-bottom:12px}.workspace-header{display:flex;justify-content:space-between;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--surface-2);padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .06s,border-color .2s,box-shadow .2s}.workspace-header:hover{transform:translateY(-1px);border-color:var(--accent)}.workspace-header.active{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in oklab,var(--accent) 35%,transparent) inset}.collapse-toggle,.mini-btn{background:0 0;border:none;color:inherit;cursor:pointer;font-size:1rem}.subpages{margin-left:8px;margin-top:8px}.subpage{padding:8px 10px;background:var(--surface);border:1px solid var(--surface-2);border-radius:10px;margin-bottom:6px;cursor:grab;font-size:.95rem;transition:border-color .2s,box-shadow .2s}.subpage:hover{border-color:var(--accent)}.subpage.active{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in oklab,var(--accent) 35%,transparent) inset}.add-workspace-btn{width:100%;padding:10px 12px;border:none;border-radius:12px;font-weight:700;cursor:pointer;color:#071217;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}.main{flex:1;display:flex;flex-direction:column padding-top: 72px}.top-bar{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:12px 16px;border-bottom:1px solid var(--surface-2);position:sticky;top:0;z-index:1000;background:var(--bg);position:fixed;top:0;left:var(--sidebar-w);right:0;z-index:2000;background:var(--bg);box-shadow:0 6px 16px rgba(0,0,0,.18);height:64px;display:grid;align-items:center}.left-controls{display:flex;gap:8px;align-items:center;justify-self:start}.right-controls{justify-self:end}.title{margin:0;font-size:1.1rem;color:var(--accent);justify-self:center;text-align:center}#reminderBtn{margin-left:-8px}.container{flex:1;display:flex;flex-direction:column;gap:12px;padding:16px}#workspaceTitle{text-align:center;font-size:1.35rem;outline:0;background:0 0;border:none;color:var(--text)}.btn,.select{background:var(--surface);color:var(--text);border:1px solid var(--surface-2);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700;text-shadow:0 1px 0 rgba(0,0,0,.25);backdrop-filter:saturate(1.2) blur(2px)}.btn:hover,.select:hover{border-color:var(--accent)}.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071217;border:none;text-shadow:none}.btn.danger{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.45);color:#fecaca}.select{appearance:none;background-clip:padding-box}.btn,.popover,.tool,select.select{color:var(--text)}select.select{background:color-mix(in oklab,var(--bg) 70%,#000 30%);border-color:color-mix(in oklab,var(--surface-2) 70%,#fff 30%)}option{background:#0d1325;color:#eaf2ff}body.light option{background:#fff;color:#111}.toolbar-wrap{display:flex;flex-direction:column;gap:8px}.toolbar-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}.toolbar{position:fixed;left:var(--sidebar-w);right:0;top:64px;z-index:2500;background:var(--bg);border-bottom:1px solid var(--surface-2);box-shadow:0 10px 24px rgba(0,0,0,.28);padding:10px 12px;display:flex;flex-wrap:wrap;gap:8px;overflow:auto;max-height:0;opacity:0;transition:max-height .25s ease,opacity .2s ease}.toolbar.show{max-height:260px;opacity:1}.tool{padding:8px 10px;border-radius:10px;background:var(--surface);border:1px solid var(--surface-2);cursor:pointer;font-weight:700;text-shadow:0 1px 0 rgba(0,0,0,.25)}.tool.active{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071217;font-weight:800;border:none;text-shadow:none}.editor-wrap{position:relative;flex:1;display:flex;flex-direction:column;gap:6px}#editor{min-height:52vh;flex:1;padding:16px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid var(--surface-2);outline:0;overflow:auto;scroll-padding-top:80px;line-height:1.6;font-size:1rem;box-shadow:var(--shadow)}#ink{position:absolute;inset:0;border-radius:14px;z-index:5;pointer-events:none}.status{font-size:.9rem;color:var(--muted);text-align:right}.float-buttons{position:fixed;top:14px;right:14px;display:flex;gap:8px;z-index:9999;align-items:center}.popover{position:fixed;top:56px;right:14px;width:360px;z-index:10000;background:rgba(17,25,40,.92);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px;box-shadow:var(--shadow);display:none;color:var(--text);backdrop-filter:blur(16px)}body.light .popover{background:rgba(255,255,255,.97);border-color:rgba(0,0,0,.12)}.popover.show{display:block;animation:pop .12s ease-out}@keyframes pop{from{transform:scale(.98);opacity:.85}to{transform:none;opacity:1}}.row{display:flex;align-items:center;gap:10px;margin-bottom:10px}.row label{opacity:.9}.range{width:100%}#downloadPopover .row{margin-bottom:8px}#downloadPopover .section{font-weight:700;margin:8px 0 4px;opacity:.9}#remodal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10002;background:rgba(0,0,0,.35)}#remodal.show{display:flex;animation:fadeIn .12s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.remodal-card{width:min(520px,92vw);background:var(--bg);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.45);color:var(--text);text-align:center;backdrop-filter:blur(18px);transform:translateX(-6vw);position:relative}.remodal-title{font-weight:800;font-size:1.05rem;margin:0 0 6px}.remodal-msg{font-size:1rem;opacity:.95;margin:0 0 10px}.remodal-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}.remodal-close{position:absolute;right:12px;top:12px;background:0 0;border:none;color:var(--text);font-size:1.1rem;cursor:pointer}#remMgrList{max-height:260px;overflow:auto;scroll-padding-top:80px;border:1px solid var(--surface-2);border-radius:10px;padding:6px}.rem-item{display:grid;grid-template-columns:2.6rem 1fr 8.2rem 6.8rem auto auto;gap:6px;align-items:center;padding:6px;border-radius:10px;background:var(--surface);margin-bottom:6px}.rem-actions button{margin-left:6px}@media (max-width:980px){:root{--sidebar-w:280px}.sidebar{display:none}}body.light .btn,body.light .select,body.light .tool{color:var(--text);border-color:var(--surface-2);background:rgba(255,255,255,.66)}body.light .btn:hover,body.light .select:hover,body.light .tool:hover{border-color:var(--accent);background:rgba(255,255,255,.85)}:root{--sidebar-w:280px}.sidebar{z-index:1500}.top-bar .left-controls,.top-bar .right-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}.top-bar .title{margin:0;text-align:center;font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.toolbar-spacer{height:0}.toolbar.show+.toolbar-spacer{height:260px}body.light .toolbar{background:rgba(255,255,255,.82);backdrop-filter:blur(6px)}.btn,a,a.btn{text-decoration:none}.no-underline{text-decoration:none!important}.editable-title:focus{outline:2px solid var(--accent);border-radius:8px}.title#appTitle{font-size:1.4rem!important;font-weight:800;color:var(--accent)}body.light .title#appTitle{color:#1e293b}.top-bar{position:fixed!important;top:0;left:var(--sidebar-w,280px);right:0;height:64px;z-index:3000}@media (max-width:980px){.top-bar{left:0}}.container,.main .container{padding-top:calc(64px + 12px)!important}#appTitle,.title#appTitle,h1#appTitle{display:none!important}.top-bar{position:fixed!important;top:0;left:0;right:0;height:64px;z-index:5000;display:flex!important;align-items:center;justify-content:space-between;padding:12px 16px!important;overflow-x:auto;white-space:nowrap;background:var(--bg)!important;border-bottom:1px solid var(--surface-2)!important}.top-bar *{white-space:nowrap}.left-controls,.right-controls{display:flex!important;align-items:center;gap:8px;flex:0 0 auto}.title#appTitle{display:none!important}.container,.main .container{padding-top:calc(64px + 12px)!important}.toolbar{position:static!important;top:auto!important;left:auto!important;right:auto!important;box-shadow:none!important;border-bottom:none!important;max-height:none!important;opacity:1!important;display:none;padding:10px 12px}.toolbar.show{display:flex!important}.wrap{padding-top:calc(64px + 12px)!important}.sidebar{position:sticky;top:calc(64px + 12px)!important;z-index:1}:root{--header-offset:88px}.wrap{padding-top:var(--header-offset)!important}.sidebar{top:var(--header-offset)!important}.container,.main .container{padding-top:var(--header-offset)!important}:root{--header-offset:96px}body{padding-top:var(--header-offset)!important}.container,.main .container,.wrap{padding-top:0!important;margin-top:0!important}.sidebar{position:sticky;top:8px!important}:root{--header-offset:76px!important}body{padding-top:var(--header-offset)!important}#leftMenuBtn,#leftMenuPanel,#rightMenuBtn,#rightMenuPanel{display:none!important}.top-bar{position:fixed!important;top:0;left:0;right:0;height:64px;z-index:5000;display:flex!important;align-items:center;justify-content:space-between;padding:12px 16px!important;overflow-x:auto!important;white-space:nowrap!important;background:var(--bg)!important;border-bottom:1px solid var(--surface-2)!important}.top-bar *{white-space:nowrap!important}.float-buttons{top:calc(var(--header-offset) + 10px)!important}.top-bar{position:fixed!important;top:0;left:0;right:0;height:auto;z-index:5000;display:flex!important;align-items:center;justify-content:flex-start;flex-wrap:wrap;padding:8px 12px!important;gap:6px;background:var(--bg)!important;border-bottom:1px solid var(--surface-2)!important}.top-bar *{white-space:nowrap}.float-buttons{display:none!important}body{padding-top:100px!important}body{padding-top:64px!important}</style><div id=pageTop style=position:absolute;top:0;left:0;width:1px;height:1px></div><aside class=sidebar><h2>Workspaces</h2><div id=workspaceList></div><button class=add-workspace-btn id=addWs>+ Add Workspace</button></aside><section class=main><div class=top-bar><div class=left-controls><button class=btn id=reminderBtn>⏰ Reminder</button> <button class="btn danger"id=deletePage>🗑 Delete Page</button> <button class=btn id=toggleToolbar>🛠️ Format</button> <button class=btn id=downloadBtn>💾 Download</button> <button class=btn id=revertBtn>🔙 Revert</button> <button class=btn id=drawToggle>✏️ Draw</button> <button class=btn id=emailBtn>✉️ Email</button> <button class=btn id=scrollTopBtn onclick="return window.__jumpToTop&&window.__jumpToTop()"type=button>⬆️ Top</button> <button class=btn id=leftMenuBtn title="Open left actions">⋯</button></div><h1 class=title id=appTitle style=font-size:1.4rem;line-height:1.2><span id=appTitleText></span><input id=appTitleInput style="display:none;width:min(60vw,600px);background:0 0;border:1px solid var(--surface-2);border-radius:8px;padding:6px 10px;color:var(--text);font:inherit;text-align:center"></h1><div class=right-controls><button class=btn id=rightMenuBtn title="Open right actions">⋯</button></div></div><div class=container><h2 contenteditable=true id=workspaceTitle spellcheck=false>Default</h2><div class=toolbar-wrap><div class=toolbar id=toolbar><button class=tool data-cmd=bold><b>B</b></button> <button class=tool data-cmd=underline><u>U</u></button> <button class=tool id=bulletsBtn>• Bullets</button> <button class=tool id=highlightBtn>🖍️ Highlight</button> <input type=color value=#fff59d class=select id=highlightColor style=width:48px;padding:6px title="Highlight color"> <select class=select id=fontSelect title=Font><option value="">Font<option>Arial<option>Courier New<option>Georgia<option>Times New Roman<option>Verdana</select> <select class=select id=fontSizeSelect title="Font size"><option value="">Size<option value=12>12px<option value=14>14px<option value=16>16px<option value=18>18px<option value=20>20px<option value=24>24px<option value=28>28px<option value=32>32px</select> <button class=tool id=checkboxBtn>☑️ Checkbox</button></div></div><div class=editor-wrap><div id=editor contenteditable=true></div><canvas id=ink></canvas></div><div class=status id=status>Loaded</div></div></section><div class=float-buttons style=display:none><button class=btn id=cfgExport>⬇️ Download Config</button> <button class=btn id=cfgImport>⬆️ Upload Config</button> <select class=select id=styleSelector title=Styles><option value="">🎨 Styles<option value=light>Light<option value=beach>Beach<option value=hacker>Hacker<option value=nature>Nature<option value=dark>Dark</select> <a class=btn href=file:///C:/Users/deanr/Desktop/Ramify/Ramify.html id=linkBtn>🐏 Ramify</a> <button class="btn primary"id=aiBtn>🧠 AI Summary</button> <button class=btn id=fsBtn>⛶ Fullscreen</button></div><div class=popover id=aiPopover><div class=row><label style=min-width:82px>Length</label> <select class=select id=sumLen style=flex:1><option value=short>Short (~20%)<option value=medium selected>Medium (~35%)<option value=long>Long (~50%)<option value=custom>Custom %</select></div><div class=row id=customRow style=display:none><label style=min-width:82px>Percent</label> <input type=range value=35 class=range id=sumPct max=95 min=5> <span id=sumPctVal>35%</span></div><div class=row><label style=min-width:82px>Bullets</label> <input type=checkbox id=sumBullets></div><div class=row style=justify-content:flex-end;gap:8px><button class=btn id=sumSel>Summarize Selection</button> <button class="btn primary"id=sumAll>Summarize All</button></div></div><div class=popover id=drawPopover><div class=row><label style=min-width:70px>Color</label> <input type=color value=#22d3ee class=select id=penColor style=width:52px;padding:6px></div><div class=row><label style=min-width:70px>Size</label> <input type=range value=6 class=range id=penSize max=28 min=2 step=1></div><div class=row style=justify-content:flex-end;gap:8px><button class=btn id=eraserBtn>🧽 Eraser: Off</button> <button class=btn id=clearInkBtn>🗑 Clear</button></div></div><div class=popover id=downloadPopover><div class=section>Scope</div><div class=row><label><input type=radio value=page name=dl-scope checked> This page</label> <label><input type=radio value=all name=dl-scope style=margin-left:12px> All workspace notes</label></div><div class=row style=justify-content:flex-end;gap:8px><button class=btn id=dlCancel>Cancel</button> <button class="btn primary"id=dlGo>Download PDF</button></div></div><div class=popover id=reminderPopover><div class=row><label style=min-width:80px>When</label> <input type=date id=remDate class=select style=flex:1> <input type=time id=remTime class=select></div><div class=row><label style=min-width:80px>Message</label> <input id=remMsg class=select style="flex:1;background:#0f1a33;border:1px solid var(--surface-2);padding:8px;border-radius:10px"placeholder="Reminder text"></div><div class=row><label style=min-width:80px>Emoji</label> <select class=select id=remEmojiSel style=flex:1><option>⏰<option>🔥<option>✅<option>📌<option>⚠️<option>🧠<option>📅<option>🚀</select></div><div class=row style=gap:8px><button class=btn id=remManage>📋 Manage Reminders</button><div style=flex:1></div><button class=btn id=remCancel>Cancel</button> <button class="btn primary"id=remSave>Save</button></div></div><div class=popover id=reminderManager><div class=row style=justify-content:space-between><strong>Queued Reminders</strong> <button class=btn id=remMgrClose>Close</button></div><div class=row style=gap:6px><label><input type=radio value=page name=mgr-scope checked> This page</label> <label style=margin-left:12px><input type=radio value=all name=mgr-scope> All pages</label></div><div id=remMgrList></div></div><div id=remodal><div class=remodal-card><button class=remodal-close id=remodalClose>✖</button><div class=remodal-title id=remodalTitle>Reminder</div><div class=remodal-msg id=remodalMsg></div><div class=remodal-actions><button class=btn id=remodalDismiss>Dismiss</button></div></div></div><div id=toast style="position:fixed;bottom:18px;right:18px;max-width:340px;display:none;background:rgba(17,25,40,.95);color:var(--text);border:1px solid rgba(255,255,255,.14);padding:12px 14px;border-radius:14px;box-shadow:var(--shadow);z-index:10001"></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js>// Added: Up arrow button to scroll to top
const scrollTopBtn = document.getElementById('scrollTopBtn');
if (scrollTopBtn) {
  scrollTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
}


// Robust Up button: scroll both window and scrollable containers
function smoothScrollToTop(el) {
  try {
    if (!el) return;
    if ('scrollTo' in el) el.scrollTo({ top: 0, behavior: 'smooth' });
    else el.scrollTop = 0;
  } catch {}
}
const upBtn = document.getElementById('scrollTopBtn');
if (upBtn) {
  upBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const editor = document.getElementById('editor');
    const main = document.querySelector('.main');
    smoothScrollToTop(window);
    smoothScrollToTop(document.documentElement);
    smoothScrollToTop(document.body);
    smoothScrollToTop(main);
    smoothScrollToTop(editor);
  });
}
// Improve overall smooth scrolling UX
try { document.documentElement.style.scrollBehavior = 'smooth'; } catch {}


// Ensure Format toggles the fixed toolbar visibility
const formatBtn = document.getElementById('toggleToolbar');
const toolbarEl = document.getElementById('toolbar');
if (formatBtn && toolbarEl) {
  formatBtn.addEventListener('click', () => {
    toolbarEl.classList.toggle('show');
  });
}
// Close toolbar when clicking outside (optional for UX)
document.addEventListener('click', (e) => {
  if (!toolbarEl) return;
  const within = toolbarEl.contains(e.target) || (formatBtn && formatBtn.contains(e.target));
  if (!within) toolbarEl.classList.remove('show');
});


// Make Up button jump to the top (robust + immediate)
const upBtn2 = document.getElementById('scrollTopBtn');
function jumpToPageTop() {
  try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch {}
  try { document.documentElement.scrollTop = 0; } catch {}
  try { document.body.scrollTop = 0; } catch {}
  const editor = document.getElementById('editor');
  const main = document.querySelector('.main');
  try { if (editor) editor.scrollTop = 0; } catch {}
  try { if (main) main.scrollTop = 0; } catch {}
}
if (upBtn2) {
  upBtn2.addEventListener('click', (e) => {
    e.preventDefault();
    jumpToPageTop();
  });
}


// DOM-ready binding for Top button
(function(){
  function jumpToPageTop() {
    try { document.documentElement.scrollTop = 0; } catch {}
    try { document.body.scrollTop = 0; } catch {}
    try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch {}
    var anchor = document.getElementById('pageTop');
    if (anchor && anchor.scrollIntoView) {
      try { anchor.scrollIntoView({ behavior: 'auto', block: 'start' }); } catch { try { anchor.scrollIntoView(); } catch {} }
    }
    // Double-tap to defeat layout shifts
    setTimeout(function(){
      try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch {}
      try { document.documentElement.scrollTop = 0; } catch {}
      try { document.body.scrollTop = 0; } catch {}
    }, 10);
  }
  function bindTop(){
    var btn = document.getElementById('scrollTopBtn');
    if (!btn) return;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      jumpToPageTop();
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindTop);
  } else {
    bindTop();
  }
})();


// === Editable workspace name synced with header title ===
(function(){
  const appTitle = document.getElementById('appTitle');
  const wsTitle = document.getElementById('workspaceTitle');
  const LS_KEY = 'workspace_name_current';

  function setTitles(t){
    if (appTitle && typeof t === 'string') appTitle.textContent = t;
    if (wsTitle && typeof t === 'string') wsTitle.textContent = t;
    try { document.title = t ? (t + ' — RamNotes') : 'RamNotes'; } catch {}
  }

  // Load saved name
  try {
    const saved = localStorage.getItem(LS_KEY);
    if (saved && saved.trim()) setTitles(saved.trim());
  } catch {}

  function save(val){
    try { localStorage.setItem(LS_KEY, val); } catch {}
  }

  function normalize(s){
    return (s || '').replace(/\s+/g,' ').trim();
  }

  function bindEditable(el){
    if (!el) return;
    el.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); el.blur(); }
    });
    el.addEventListener('input', ()=>{
      const v = normalize(el.textContent);
      setTitles(v);
    });
    el.addEventListener('blur', ()=>{
      const v = normalize(el.textContent);
      setTitles(v);
      save(v);
    });
  }

  bindEditable(appTitle);
  bindEditable(wsTitle);
})();


// === Bind header title to current workspace name (per-workspace) ===
(function(){
  const appTitle = document.getElementById('appTitle');
  if (!appTitle) return;
  function norm(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function currentName(){
    try { return localStorage.getItem(keyTitle(currentWorkspace)) || currentWorkspace.split('::').pop(); } catch { return currentWorkspace.split('::').pop(); }
  }
  function setAll(t){
    const v = norm(t);
    try { localStorage.setItem(keyTitle(currentWorkspace), v); } catch {}
    try { els.title.textContent = v; } catch {}
    try { appTitle.textContent = v; } catch {}
    try { renderWorkspaces(); } catch {}
    try { document.title = v ? (v + ' — RamNotes') : 'RamNotes'; } catch {}
  }
  // Initialize header title from current workspace on load
  try { appTitle.textContent = currentName(); } catch {}
  // Keep header updated whenever loadNote runs (e.g., after switching workspaces)
  if (typeof loadNote === 'function'){
    const __origLoadNote = loadNote;
    window.loadNote = function(){
      __origLoadNote();
      try { appTitle.textContent = currentName(); } catch {}
    };
  }
  // Make both header and small workspace title editable and synced
  function bindEditable(el){
    if(!el) return;
    el.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
    });
    el.addEventListener('input', ()=>{
      const v = norm(el.textContent);
      appTitle.textContent = v;
      try { els.title.textContent = v; } catch {}
    });
    el.addEventListener('blur', ()=>{
      setAll(el.textContent);
    });
  }
  bindEditable(appTitle);
  try { bindEditable(els.title); } catch {}
})();


// === Robust per-workspace title sync (header <-> workspace) ===
(function(){
  const appTitle = document.getElementById('appTitle');
  const wsTitle = document.getElementById('workspaceTitle');
  function norm(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function getCurrentWsTitle(){
    try { return localStorage.getItem(keyTitle(currentWorkspace)) || currentWorkspace.split('::').pop(); }
    catch { return currentWorkspace.split('::').pop(); }
  }
  function setCurrentWsTitle(name){
    const v = norm(name);
    try { localStorage.setItem(keyTitle(currentWorkspace), v); } catch {}
    if (appTitle) appTitle.textContent = v;
    if (wsTitle) wsTitle.textContent = v;
    try { document.title = v ? (v + ' — RamNotes') : 'RamNotes'; } catch {}
    try { renderWorkspaces(); } catch {}
  }
  function updateFromStorage(){
    const v = getCurrentWsTitle();
    if (appTitle && appTitle.textContent !== v) appTitle.textContent = v;
    if (wsTitle && wsTitle.textContent !== v) wsTitle.textContent = v;
    try { document.title = v ? (v + ' — RamNotes') : 'RamNotes'; } catch {}
  }

  // Bind editing on both titles
  function bindEditable(el){
    if (!el) return;
    el.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); el.blur(); }
    });
    el.addEventListener('input', ()=>{
      const v = norm(el.textContent);
      if (appTitle && el!==appTitle) appTitle.textContent = v;
      if (wsTitle && el!==wsTitle) wsTitle.textContent = v;
    });
    el.addEventListener('blur', ()=>{ setCurrentWsTitle(el.textContent); });
  }
  bindEditable(appTitle);
  bindEditable(wsTitle);

  // Hook into load sequence
  if (typeof window.addEventListener === 'function'){
    window.addEventListener('load', ()=>{ updateFromStorage(); });
  } else {
    updateFromStorage();
  }

  // Monkey-patch switchWorkspace to keep titles synced
  if (typeof window.switchWorkspace === 'function'){
    const __old = window.switchWorkspace;
    window.switchWorkspace = function(id){
      __old(id);
      updateFromStorage();
    };
  }

  // Also patch loadNote to refresh header after content loads
  if (typeof window.loadNote === 'function'){
    const __oldLoad = window.loadNote;
    window.loadNote = function(){
      __oldLoad();
      updateFromStorage();
    };
  }
})();


// === Single Source of Truth for Workspace Name (Header <-> Workspace) ===
(function(){
  const appTitle = document.getElementById('appTitle');
  const wsTitle  = document.getElementById('workspaceTitle');

  function norm(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function getKey(){ return typeof keyTitle==='function' ? keyTitle(currentWorkspace) : ('quicknotes-title-'+currentWorkspace); }
  function getName(){
    try { return localStorage.getItem(getKey()) || (currentWorkspace||'').split('::').pop(); }
    catch { return (currentWorkspace||'').split('::').pop(); }
  }
  function setName(v){
    const name = norm(v);
    try { localStorage.setItem(getKey(), name); } catch {}
    try { document.title = name ? (name + ' — RamNotes') : 'RamNotes'; } catch {}
    if (appTitle) appTitle.textContent = name;
    if (wsTitle)  wsTitle.textContent  = name;
    try { renderWorkspaces(); } catch {}
  }

  // Initialize both titles from storage on load
  function initTitles(){
    const n = getName();
    if (appTitle) appTitle.textContent = n;
    if (wsTitle)  wsTitle.textContent  = n;
  }

  // Bind editable behavior
  function bindEditable(el){
    if (!el) return;
    el.setAttribute('contenteditable','true');
    el.setAttribute('spellcheck','false');
    el.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); el.blur(); }
    });
    el.addEventListener('input', ()=>{
      const v = norm(el.textContent);
      if (appTitle && el!==appTitle) appTitle.textContent = v;
      if (wsTitle  && el!==wsTitle ) wsTitle.textContent  = v;
    });
    el.addEventListener('blur', ()=>{
      setName(el.textContent);
    });
  }

  // Hook into existing app lifecycle
  window.addEventListener('load', ()=>{
    initTitles();
    bindEditable(appTitle);
    bindEditable(wsTitle);
  });

  // Patch loadNote so switching workspaces updates header title
  if (typeof window.loadNote === 'function'){
    const __oldLoadNote = window.loadNote;
    window.loadNote = function(){
      __oldLoadNote();
      initTitles();
    };
  }

  // Patch switchWorkspace too, just in case
  if (typeof window.switchWorkspace === 'function'){
    const __oldSwitch = window.switchWorkspace;
    window.switchWorkspace = function(id){
      __oldSwitch(id);
      initTitles();
    };
  }
})();</script><script src=https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js></script><style id=rn_patch_v11_css>#workspaceList .workspace .workspace-header,.workspace .workspace-header,.workspace-list .workspace .workspace-header{display:flex;flex-wrap:nowrap!important;align-items:center;gap:6px}#workspaceList .workspace .workspace-header .name,#workspaceList .workspace .workspace-header .title,#workspaceList .workspace .workspace-header .ws-title,#workspaceList .workspace .workspace-header select,#workspaceList .workspace .workspace-header>span,.workspace .workspace-header .name,.workspace .workspace-header .title,.workspace .workspace-header .ws-title,.workspace .workspace-header>span{flex:1 1 auto;min-width:0;white-space:normal!important;overflow-wrap:anywhere;word-break:break-word;line-height:1.2}#workspaceList .workspace,.workspace-list .workspace{height:auto!important}.rn-arrow{width:22px;height:22px;border-radius:7px;display:grid;place-items:center;background:var(--rn-btn-bg,#141c2b);color:var(--rn-btn-text,#e6edf7);border:1px solid var(--rn-btn-border,#22304a);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.25);transition:transform .08s ease;font-size:12px;line-height:1}body.light .rn-arrow{background:#fff;color:#0f172a;border-color:#cbd5e1}.rn-arrow:hover{transform:translateY(-1px)}.rn-arrow+.rn-arrow{margin-left:4px}body.light,body.theme-light{--rn-bg:#f7f9fc;--rn-card:#ffffff;--rn-card-2:#f2f5fb;--rn-text:#0f172a;--rn-muted:#475569;--rn-accent:#2563eb;--rn-accent-2:#7c3aed;--rn-border:#d7dee7;--rn-btn-bg:#ffffff;--rn-btn-text:#0f172a;--rn-btn-border:#cbd5e1;--rn-sidebar:#ffffff;--rn-header:#eef2f8}body.dark,body.theme-dark{--rn-bg:#0e1420;--rn-card:#101826;--rn-card-2:#152034;--rn-text:#e6edf7;--rn-muted:#9fb0c9;--rn-accent:#22d3ee;--rn-accent-2:#a78bfa;--rn-border:#23314b;--rn-btn-bg:#141c2b;--rn-btn-text:#e6edf7;--rn-btn-border:#22304a;--rn-sidebar:#0f172a;--rn-header:#121a2a}body.ocean,body.theme-ocean{--rn-bg:#0c4a6e;--rn-card:#0a3c59;--rn-card-2:#0b3550;--rn-text:#e6f7ff;--rn-muted:#bcd7e6;--rn-accent:#38bdf8;--rn-accent-2:#22d3ee;--rn-border:#0e5f8b;--rn-btn-bg:#0b4362;--rn-btn-text:#e6f7ff;--rn-btn-border:#0e608a;--rn-sidebar:#093a55;--rn-header:#0a4463}body.forest,body.theme-forest{--rn-bg:#0a1e15;--rn-card:#10271d;--rn-card-2:#143627;--rn-text:#eafff1;--rn-muted:#a9d7bf;--rn-accent:#34d399;--rn-accent-2:#86efac;--rn-border:#1b3a2c;--rn-btn-bg:#133224;--rn-btn-text:#eafff1;--rn-btn-border:#1d4d37;--rn-sidebar:#0f2a1f;--rn-header:#123426}body.hacker,body.theme-hacker{--rn-bg:#000000;--rn-card:#07140b;--rn-card-2:#0a1e10;--rn-text:#d1ffd6;--rn-muted:#8bffb5;--rn-accent:#00ff7f;--rn-accent-2:#39ff14;--rn-border:#0f3a1c;--rn-btn-bg:#0a1e10;--rn-btn-text:#d1ffd6;--rn-btn-border:#0f3a1c;--rn-sidebar:#050f09;--rn-header:#091a0f}body.neonberry,body.theme-neonberry{--rn-bg:#1a1025;--rn-card:#231136;--rn-card-2:#2b1542;--rn-text:#fbe9ff;--rn-muted:#e2b8ff;--rn-accent:#ff5ea8;--rn-accent-2:#c084fc;--rn-border:#3d215a;--rn-btn-bg:#2a1640;--rn-btn-text:#fbe9ff;--rn-btn-border:#4a2b6f;--rn-sidebar:#201238;--rn-header:#281542}body,html{background-color:var(--rn-bg,#0e1420)!important;background-image:none!important;color:var(--rn-text,#e6edf7)!important}.container,.top-bar{background-color:var(--rn-card,transparent)!important;border-color:var(--rn-border,transparent)!important}#workspaceList,.left-sidebar,.sidebar,.workspace-bar,.workspace-list{background-color:var(--rn-sidebar,transparent)!important}#rnStylesBtn.floating{position:fixed;top:12px;left:12px;z-index:9999;padding:6px 10px;border-radius:10px;background:var(--rn-btn-bg,#fff);color:var(--rn-btn-text,#0f172a);border:1px solid var(--rn-btn-border,#cbd5e1)}#rnStylesMenu{position:fixed;top:56px;left:12px;z-index:10000;display:none;padding:10px;border-radius:12px;background:#fff;color:#0f172a;border:1px solid #d1d5db;box-shadow:0 10px 30px rgba(0,0,0,.25)}#rnStylesMenu.show{display:block}#rnStylesMenu .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}#rnStylesMenu .chip{padding:8px;border:1px solid #d1d5db;border-radius:10px;background:#f8f9fb;cursor:pointer}</style><style id=rn_seam_fix_v12>body,html{background-color:var(--rn-bg,#0e1420)!important;background-image:none!important}#root,.app,.canvas,.content,.editor-container,.editor-wrap,.main,.page,.root,.viewport{background-color:transparent!important;background-image:none!important;box-shadow:none!important;border-top:0!important;border-bottom:0!important}.container,.header,.section,.surface,.top-bar{background-color:transparent!important;background-image:none!important;box-shadow:none!important;border-top:0!important;border-bottom:0!important}.container::after,.container::before,.content::after,.content::before,.main::after,.main::before,.page::after,.page::before,.top-bar::after,.top-bar::before,body::after,body::before{content:none!important}#leftSidebar,#workspaceList,.left-sidebar,.sidebar,.workspace-bar{background-color:var(--rn-sidebar,transparent)!important;border-color:var(--rn-border,transparent)!important}.workspace-header{background-color:var(--rn-header,transparent)!important}hr{border:0!important;height:0!important;background:0 0!important}</style>

<!-- © 2025 Ramifyy — All Rights Reserved. 
Unauthorized copying, distribution, or modification is strictly prohibited. 
RIP Jeff Horn 🕊️ -->
<script>
/* RamNotes inline-script loader (UTF‑8 safe, preserves order & module type) */
(function(){
  var list = [{"t":"classic","d":"LyogPT09PT0gRWxlbWVudHMgJiBTdGF0ZSA9PT09PSAqLwpjb25zdCBlbHMgPSB7CiAgd29ya3NwYWNlTGlzdDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dvcmtzcGFjZUxpc3QnKSwKICBhZGRXczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkZFdzJyksCiAgZGVsZXRlUGFnZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RlbGV0ZVBhZ2UnKSwKICByZW1pbmRlckJ0bjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbWluZGVyQnRuJyksCiAgdGl0bGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3b3Jrc3BhY2VUaXRsZScpLAogIGVkaXRvcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VkaXRvcicpLAogIHN0YXR1czogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1cycpLAoKICB0b2dnbGVUb29sYmFyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9nZ2xlVG9vbGJhcicpLAogIHRvb2xiYXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b29sYmFyJyksCiAgZm9udFNlbGVjdDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZvbnRTZWxlY3QnKSwKICBmb250U2l6ZVNlbGVjdDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZvbnRTaXplU2VsZWN0JyksCiAgY2hlY2tib3hCdG46IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGVja2JveEJ0bicpLAogIGJ1bGxldHNCdG46IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidWxsZXRzQnRuJyksCgogIHN0eWxlU2VsZWN0b3I6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdHlsZVNlbGVjdG9yJyksCiAgZG93bmxvYWRCdG46IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb3dubG9hZEJ0bicpLAogIGRvd25sb2FkUG9wb3ZlcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rvd25sb2FkUG9wb3ZlcicpLAogIGRsR286IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbEdvJyksCiAgZGxDYW5jZWw6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbENhbmNlbCcpLAogIHJldmVydEJ0bjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JldmVydEJ0bicpLAogIGZzQnRuOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZnNCdG4nKSwKICBsaW5rQnRuOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGlua0J0bicpLAogIGVtYWlsQnRuOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW1haWxCdG4nKSwKCiAgYWlCdG46IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhaUJ0bicpLAogIGFpUG9wb3ZlcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FpUG9wb3ZlcicpLAogIHN1bUxlbjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1bUxlbicpLAogIGN1c3RvbVJvdzogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1c3RvbVJvdycpLAogIHN1bVBjdDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1bVBjdCcpLAogIHN1bVBjdFZhbDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1bVBjdFZhbCcpLAogIHN1bUJ1bGxldHM6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdW1CdWxsZXRzJyksCiAgc3VtU2VsOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3VtU2VsJyksCiAgc3VtQWxsOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3VtQWxsJyksCgogIGRyYXdUb2dnbGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmF3VG9nZ2xlJyksCiAgZHJhd1BvcG92ZXI6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmF3UG9wb3ZlcicpLAogIHBlbkNvbG9yOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGVuQ29sb3InKSwKICBwZW5TaXplOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGVuU2l6ZScpLAogIGVyYXNlckJ0bjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VyYXNlckJ0bicpLAogIGNsZWFySW5rQnRuOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2xlYXJJbmtCdG4nKSwKCiAgaGlnaGxpZ2h0QnRuOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlnaGxpZ2h0QnRuJyksCiAgaGlnaGxpZ2h0Q29sb3I6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWdobGlnaHRDb2xvcicpLAoKICBpbms6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbmsnKSwKCiAgcmVtaW5kZXJQb3BvdmVyOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtaW5kZXJQb3BvdmVyJyksCiAgcmVtRGF0ZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbURhdGUnKSwKICByZW1UaW1lOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtVGltZScpLAogIHJlbU1zZzogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbU1zZycpLAogIHJlbUVtb2ppU2VsOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtRW1vamlTZWwnKSwKICByZW1TYXZlOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtU2F2ZScpLAogIHJlbUNhbmNlbDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbUNhbmNlbCcpLAogIHJlbU1hbmFnZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbU1hbmFnZScpLAoKICByZW1NZ3I6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1pbmRlck1hbmFnZXInKSwKICByZW1NZ3JMaXN0OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtTWdyTGlzdCcpLAogIHJlbU1nckNsb3NlOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtTWdyQ2xvc2UnKSwKCiAgcmVtb2RhbDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW9kYWwnKSwKICByZW1vZGFsVGl0bGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vZGFsVGl0bGUnKSwKICByZW1vZGFsTXNnOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb2RhbE1zZycpLAogIHJlbW9kYWxDbG9zZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW9kYWxDbG9zZScpLAogIHJlbW9kYWxEaXNtaXNzOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb2RhbERpc21pc3MnKSwKCiAgdG9hc3Q6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdCcpLAp9OwpsZXQgd29ya3NwYWNlcyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3F1aWNrbm90ZXMtd29ya3NwYWNlcycpIHx8ICdbXScpOwpsZXQgY3VycmVudFdvcmtzcGFjZSA9IHdvcmtzcGFjZXNbMF0gfHwgJ2RlZmF1bHQnOwpsZXQgc2F2ZVRpbWVyOwoKLyogRHJhd2luZyAqLwpsZXQgZHJhd2luZ09uID0gZmFsc2U7CmxldCBkcmF3TW9kZSA9ICdwZW4nOwpsZXQgc3Ryb2tlcyA9IFtdOwpsZXQgY3VycmVudFN0cm9rZSA9IG51bGw7CgovKiBSZW1pbmRlcnMgKi8KbGV0IHJlbWluZGVyVGltZXIgPSBudWxsOwoKLyogU3RvcmFnZSBrZXlzICovCmNvbnN0IGtleU5vdGUgPSAobik9PmBxdWlja25vdGVzLSR7bn1gOwpjb25zdCBrZXlUaXRsZT0gKG4pPT5gcXVpY2tub3Rlcy10aXRsZS0ke259YDsKY29uc3Qga2V5U3VicyA9IChuKT0+YHF1aWNrbm90ZXMtc3VicGFnZXMtJHtufWA7CmNvbnN0IGtleUluayAgPSAobik9PmBxdWlja25vdGVzLWluay0ke259YDsKY29uc3Qga2V5SGlzdCA9IChuKT0+YCR7a2V5Tm90ZShuKX0taGlzdG9yeWA7CmNvbnN0IGtleUNvbGxhcHNlID0gKHdzKT0+YHF1aWNrbm90ZXMtY29sbGFwc2UtJHt3c31gOwpjb25zdCBrZXlSZW1pbmRlciA9IChuKT0+YHF1aWNrbm90ZXMtcmVtaW5kZXJzLSR7bn1gOwoKLyogPT09PT0gSW5pdCA9PT09PSAqLwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpPT57CiAgaWYoIXdvcmtzcGFjZXMuaW5jbHVkZXMoJ2RlZmF1bHQnKSkgd29ya3NwYWNlcy51bnNoaWZ0KCdkZWZhdWx0Jyk7CiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3F1aWNrbm90ZXMtd29ya3NwYWNlcycsIEpTT04uc3RyaW5naWZ5KHdvcmtzcGFjZXMpKTsKCiAgY29uc3Qgc2F2ZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncXVpY2tub3Rlcy1jdXJyZW50LXdvcmtzcGFjZScpOwogIGlmKHNhdmVkICYmIHZhbGlkV29ya3NwYWNlSWQoc2F2ZWQpKSBjdXJyZW50V29ya3NwYWNlID0gc2F2ZWQ7CgogIGFwcGx5U2F2ZWRUaGVtZSgpOwogIHJlbmRlcldvcmtzcGFjZXMoKTsKICBsb2FkTm90ZSgpOwogIHJlc2l6ZUlua0NhbnZhcygpOwogIHN0YXJ0UmVtaW5kZXJUaWNrZXIoKTsKfSk7CgovKiA9PT09PSBUaGVtZSA9PT09PSAqLwplbHMuc3R5bGVTZWxlY3Rvci5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSk9PnsKICBjb25zdCB2ID0gZS50YXJnZXQudmFsdWU7CiAgZG9jdW1lbnQuYm9keS5jbGFzc05hbWUgPSAnJzsKICBpZih2ICYmIHYhPT0nZGFyaycpIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCh2KTsKICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgncmFtbm90ZXMtdGhlbWUnLCB2KTsKICBlLnRhcmdldC5zZWxlY3RlZEluZGV4ID0gMDsKfSk7CmZ1bmN0aW9uIGFwcGx5U2F2ZWRUaGVtZSgpewogIGNvbnN0IHYgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncmFtbm90ZXMtdGhlbWUnKTsKICBpZih2ICYmIHYhPT0nZGFyaycpIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCh2KTsKfQoKLyogPT09PT0gV29ya3NwYWNlcyA9PT09PSAqLwplbHMuYWRkV3MuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ewogIGNvbnN0IG5hbWUgPSBwcm9tcHQoJ05ldyB3b3Jrc3BhY2UgbmFtZTonKT8udHJpbSgpOwogIGlmKCFuYW1lKSByZXR1cm47CiAgaWYod29ya3NwYWNlcy5pbmNsdWRlcyhuYW1lKSl7IGFsZXJ0KCdOYW1lIGFscmVhZHkgZXhpc3RzLicpOyByZXR1cm47IH0KICB3b3Jrc3BhY2VzLnB1c2gobmFtZSk7CiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3F1aWNrbm90ZXMtd29ya3NwYWNlcycsIEpTT04uc3RyaW5naWZ5KHdvcmtzcGFjZXMpKTsKICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXlUaXRsZShuYW1lKSwgbmFtZSk7CiAgcmVuZGVyV29ya3NwYWNlcygpOwp9KTsKZnVuY3Rpb24gdmFsaWRXb3Jrc3BhY2VJZChpZCl7CiAgY29uc3QgW2Jhc2UsIHN1Yl0gPSBpZC5zcGxpdCgnOjonKTsKICBjb25zdCBtYWluT2sgPSB3b3Jrc3BhY2VzLmluY2x1ZGVzKGJhc2UpOwogIGNvbnN0IHN1Yk9rID0gIXN1YiB8fCAoSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlTdWJzKGJhc2UpKXx8J1tdJykpLmluY2x1ZGVzKHN1Yik7CiAgcmV0dXJuIG1haW5PayAmJiBzdWJPazsKfQpmdW5jdGlvbiBzd2l0Y2hXb3Jrc3BhY2UoaWQpewogIHNhdmVOb3RlKCk7CiAgY3VycmVudFdvcmtzcGFjZSA9IGlkOwogIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdxdWlja25vdGVzLWN1cnJlbnQtd29ya3NwYWNlJywgaWQpOwogIGxvYWROb3RlKCk7CiAgcmVuZGVyV29ya3NwYWNlcygpOwp9CmZ1bmN0aW9uIGFkZFN1YnBhZ2Uod3MpewogIGNvbnN0IG5hbWUgPSBwcm9tcHQoJ05ldyBzdWJwYWdlIG5hbWU6Jyk/LnRyaW0oKTsKICBpZighbmFtZSkgcmV0dXJuOwogIGNvbnN0IGsgPSBrZXlTdWJzKHdzKTsKICBjb25zdCBzdWJzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKSB8fCAnW10nKTsKICBzdWJzLnB1c2gobmFtZSk7CiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oaywgSlNPTi5zdHJpbmdpZnkoc3VicykpOwogIHJlbmRlcldvcmtzcGFjZXMoKTsKfQpmdW5jdGlvbiByZW5kZXJXb3Jrc3BhY2VzKCl7CiAgZWxzLndvcmtzcGFjZUxpc3QuaW5uZXJIVE1MID0gJyc7CiAgd29ya3NwYWNlcy5mb3JFYWNoKHdzPT57CiAgICBjb25zdCB3cmFwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IHdyYXAuY2xhc3NOYW1lPSd3b3Jrc3BhY2UnOwogICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGhlYWRlci5jbGFzc05hbWU9J3dvcmtzcGFjZS1oZWFkZXInOwogICAgY29uc3QgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7CiAgICBsYWJlbC50ZXh0Q29udGVudCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVRpdGxlKHdzKSkgfHwgd3M7CgogICAgY29uc3QgdG9nZ2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7IHRvZ2dsZS5jbGFzc05hbWU9J2NvbGxhcHNlLXRvZ2dsZSc7CiAgICBjb25zdCBjb2xsYXBzZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlDb2xsYXBzZSh3cykpID09PSAndHJ1ZSc7CiAgICB0b2dnbGUudGV4dENvbnRlbnQgPSBjb2xsYXBzZWQgPyAn4pa4JyA6ICfilr4nOwoKICAgIGNvbnN0IGFkZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOyBhZGQuY2xhc3NOYW1lPSdtaW5pLWJ0bic7IGFkZC50ZXh0Q29udGVudD0nKyc7CiAgICBjb25zdCBzdWJzV3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBzdWJzV3JhcC5jbGFzc05hbWU9J3N1YnBhZ2VzJzsKICAgIHN1YnNXcmFwLnN0eWxlLmRpc3BsYXkgPSBjb2xsYXBzZWQgPyAnbm9uZScgOiAnYmxvY2snOwoKICAgIGhlYWRlci5vbmNsaWNrID0gKCk9PnN3aXRjaFdvcmtzcGFjZSh3cyk7CiAgICBpZihjdXJyZW50V29ya3NwYWNlPT09d3MpIGhlYWRlci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsgZWxzZSBoZWFkZXIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICB0b2dnbGUub25jbGljayA9IChlKT0+ewogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICBjb25zdCBpc0hpZGRlbiA9IHN1YnNXcmFwLnN0eWxlLmRpc3BsYXk9PT0nbm9uZSc7CiAgICAgIHN1YnNXcmFwLnN0eWxlLmRpc3BsYXkgPSBpc0hpZGRlbiA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgIHRvZ2dsZS50ZXh0Q29udGVudCA9IGlzSGlkZGVuID8gJ+KWvicgOiAn4pa4JzsKICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5Q29sbGFwc2Uod3MpLCAoIWlzSGlkZGVuKS50b1N0cmluZygpKTsKICAgIH07CiAgICBhZGQub25jbGljaz0oZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgYWRkU3VicGFnZSh3cyk7IH07CgogICAgaGVhZGVyLmFwcGVuZChsYWJlbCx0b2dnbGUsYWRkKTsKICAgIHdyYXAuYXBwZW5kKGhlYWRlcik7CgogICAgY29uc3Qgc3VicyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5U3Vicyh3cykpIHx8ICdbXScpOwogICAgc3Vicy5mb3JFYWNoKChzdWIsIGluZGV4KT0+ewogICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBlbC5jbGFzc05hbWU9J3N1YnBhZ2UnOyBlbC50ZXh0Q29udGVudD1zdWI7IGVsLmRyYWdnYWJsZT10cnVlOwogICAgICBjb25zdCBpZCA9IGAke3dzfTo6JHtzdWJ9YDsKICAgICAgZWwub25jbGljaz0oKT0+c3dpdGNoV29ya3NwYWNlKGlkKTsKICAgICAgaWYoY3VycmVudFdvcmtzcGFjZT09PWlkKSBlbC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsgZWxzZSBlbC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgZWwub25kcmFnc3RhcnQ9KGUpPT57IGUuZGF0YVRyYW5zZmVyLnNldERhdGEoJ2lkeCcsIGluZGV4KTsgZS5kYXRhVHJhbnNmZXIuc2V0RGF0YSgnd3MnLCB3cyk7IH07CiAgICAgIGVsLm9uZHJhZ292ZXI9KGUpPT5lLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGVsLm9uZHJvcD0oZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgY29uc3QgZnJvbUlkeCA9ICtlLmRhdGFUcmFuc2Zlci5nZXREYXRhKCdpZHgnKTsKICAgICAgICBjb25zdCBmcm9tV3MgPSBlLmRhdGFUcmFuc2Zlci5nZXREYXRhKCd3cycpOwogICAgICAgIGlmKGZyb21XcyE9PXdzKSByZXR1cm47CiAgICAgICAgY29uc3QgZHJvcElkeCA9IEFycmF5LmZyb20oc3Vic1dyYXAuY2hpbGRyZW4pLmluZGV4T2YoZWwpOwogICAgICAgIGNvbnN0IGxpc3QgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVN1YnMod3MpKSB8fCAnW10nKTsKICAgICAgICBjb25zdCBbbW92ZWRdID0gbGlzdC5zcGxpY2UoZnJvbUlkeCwxKTsKICAgICAgICBsaXN0LnNwbGljZShkcm9wSWR4LDAsbW92ZWQpOwogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleVN1YnMod3MpLCBKU09OLnN0cmluZ2lmeShsaXN0KSk7CiAgICAgICAgcmVuZGVyV29ya3NwYWNlcygpOwogICAgICB9OwogICAgICBzdWJzV3JhcC5hcHBlbmRDaGlsZChlbCk7CiAgICB9KTsKCiAgICB3cmFwLmFwcGVuZENoaWxkKHN1YnNXcmFwKTsKICAgIGVscy53b3Jrc3BhY2VMaXN0LmFwcGVuZENoaWxkKHdyYXApOwogIH0pOwp9CgovKiA9PT09PSBMb2FkIC8gU2F2ZSA9PT09PSAqLwpmdW5jdGlvbiBsb2FkTm90ZSgpewogIGVscy5lZGl0b3IuaW5uZXJIVE1MID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5Tm90ZShjdXJyZW50V29ya3NwYWNlKSkgfHwgJyc7CiAgZWxzLnRpdGxlLnRleHRDb250ZW50ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5VGl0bGUoY3VycmVudFdvcmtzcGFjZSkpIHx8IGN1cnJlbnRXb3Jrc3BhY2Uuc3BsaXQoJzo6JykucG9wKCk7CiAgc3Ryb2tlcyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5SW5rKGN1cnJlbnRXb3Jrc3BhY2UpKSB8fCAnW10nKTsKICByZWRyYXdJbmsoKTsKICBlbHMuc3RhdHVzLnRleHRDb250ZW50PSdMb2FkZWQnOwp9CmZ1bmN0aW9uIHNhdmVOb3RlKCl7CiAgY29uc3QgayA9IGtleU5vdGUoY3VycmVudFdvcmtzcGFjZSk7CiAgY29uc3QgY29udGVudCA9IGVscy5lZGl0b3IuaW5uZXJIVE1MOwogIGNvbnN0IGhrID0ga2V5SGlzdChjdXJyZW50V29ya3NwYWNlKTsKICBjb25zdCBoaXN0ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShoaykgfHwgJ1tdJyk7CiAgaWYoaGlzdC5sZW5ndGg9PT0wIHx8IGhpc3RbaGlzdC5sZW5ndGgtMV0hPT1jb250ZW50KXsKICAgIGhpc3QucHVzaChjb250ZW50KTsgaWYoaGlzdC5sZW5ndGg+NTApIGhpc3Quc2hpZnQoKTsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGhrLCBKU09OLnN0cmluZ2lmeShoaXN0KSk7CiAgfQogIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGssIGNvbnRlbnQpOwogIGVscy5zdGF0dXMudGV4dENvbnRlbnQ9J1NhdmVkJzsKfQpmdW5jdGlvbiBzYXZlU29vbigpeyBjbGVhclRpbWVvdXQoc2F2ZVRpbWVyKTsgc2F2ZVRpbWVyPXNldFRpbWVvdXQoc2F2ZU5vdGUsIDIyMCk7IH0KCmVscy5lZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKT0+ewogIGNsZWFyVGltZW91dChzYXZlVGltZXIpOwogIGVscy5zdGF0dXMudGV4dENvbnRlbnQ9J1NhdmluZ+KApic7CiAgc2F2ZVRpbWVyID0gc2V0VGltZW91dChzYXZlTm90ZSwgMzUwKTsKfSk7CgovKiBDaGVja2JveCBwZXJzaXN0ZW5jZSAqLwpmdW5jdGlvbiBwZXJzaXN0Q2hlY2tib3hTdGF0ZShlbCl7CiAgaWYoZWwuY2hlY2tlZCkgZWwuc2V0QXR0cmlidXRlKCdjaGVja2VkJywnJyk7CiAgZWxzZSBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NoZWNrZWQnKTsKICBzYXZlU29vbigpOwp9CmVscy5lZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICBpZihlLnRhcmdldCAmJiBlLnRhcmdldC50eXBlPT09J2NoZWNrYm94Jyl7IHBlcnNpc3RDaGVja2JveFN0YXRlKGUudGFyZ2V0KTsgfQp9LCB0cnVlKTsKZWxzLmVkaXRvci5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSk9PnsKICBpZihlLnRhcmdldCAmJiBlLnRhcmdldC50eXBlPT09J2NoZWNrYm94Jyl7IHBlcnNpc3RDaGVja2JveFN0YXRlKGUudGFyZ2V0KTsgfQp9LCB0cnVlKTsKCmVscy50aXRsZS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57IGlmKGUua2V5PT09J0VudGVyJyl7IGUucHJldmVudERlZmF1bHQoKTsgZWxzLnRpdGxlLmJsdXIoKTsgfSB9KTsKZWxzLnRpdGxlLmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCAoKT0+ewogIGNvbnN0IHQgPSBlbHMudGl0bGUudGV4dENvbnRlbnQudHJpbSgpIHx8ICdVbnRpdGxlZCc7CiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5VGl0bGUoY3VycmVudFdvcmtzcGFjZSksIHQpOwogIHJlbmRlcldvcmtzcGFjZXMoKTsKfSk7CgovKiBEZWxldGUgcGFnZSAqLwplbHMuZGVsZXRlUGFnZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57CiAgaWYoY3VycmVudFdvcmtzcGFjZT09PSdkZWZhdWx0Jyl7IGFsZXJ0KCdDYW5ub3QgZGVsZXRlIHRoZSBkZWZhdWx0IHBhZ2UuJyk7IHJldHVybjsgfQogIGlmKCFjb25maXJtKGBEZWxldGUgIiR7Y3VycmVudFdvcmtzcGFjZX0iP2ApKSByZXR1cm47CgogIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleU5vdGUoY3VycmVudFdvcmtzcGFjZSkpOwogIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleVRpdGxlKGN1cnJlbnRXb3Jrc3BhY2UpKTsKICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXlJbmsoY3VycmVudFdvcmtzcGFjZSkpOwogIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleUhpc3QoY3VycmVudFdvcmtzcGFjZSkpOwogIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleVJlbWluZGVyKGN1cnJlbnRXb3Jrc3BhY2UpKTsKCiAgY29uc3QgW2Jhc2UsIHN1Yl0gPSBjdXJyZW50V29ya3NwYWNlLnNwbGl0KCc6OicpOwogIGlmKHN1Yil7CiAgICBsZXQgc3VicyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5U3VicyhiYXNlKSkgfHwgJ1tdJyk7CiAgICBzdWJzID0gc3Vicy5maWx0ZXIocz0+cyE9PXN1Yik7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXlTdWJzKGJhc2UpLCBKU09OLnN0cmluZ2lmeShzdWJzKSk7CiAgfWVsc2V7CiAgICB3b3Jrc3BhY2VzID0gd29ya3NwYWNlcy5maWx0ZXIodz0+dyE9PWJhc2UpOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3F1aWNrbm90ZXMtd29ya3NwYWNlcycsIEpTT04uc3RyaW5naWZ5KHdvcmtzcGFjZXMpKTsKICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleVN1YnMoYmFzZSkpOwogIH0KICBjdXJyZW50V29ya3NwYWNlPSdkZWZhdWx0JzsKICBsb2FkTm90ZSgpOwogIHJlbmRlcldvcmtzcGFjZXMoKTsKfSk7CgovKiA9PT09PSBUb29sYmFyIC8gQ29tbWFuZHMgPT09PT0gKi8KZnVuY3Rpb24gZXhlYyhjbWQsIHZhbD1udWxsKXsgZG9jdW1lbnQuZXhlY0NvbW1hbmQoY21kLCBmYWxzZSwgdmFsKTsgZWxzLmVkaXRvci5mb2N1cygpOyB1cGRhdGVUb2dnbGVTdGF0ZSgpOyB9CmZ1bmN0aW9uIHVwZGF0ZVRvZ2dsZVN0YXRlKCl7CiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRvb2xbZGF0YS1jbWQ9ImJvbGQiXScpLmZvckVhY2goYj0+Yi5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCBkb2N1bWVudC5xdWVyeUNvbW1hbmRTdGF0ZSgnYm9sZCcpKSk7CiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRvb2xbZGF0YS1jbWQ9InVuZGVybGluZSJdJykuZm9yRWFjaChiPT5iLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIGRvY3VtZW50LnF1ZXJ5Q29tbWFuZFN0YXRlKCd1bmRlcmxpbmUnKSkpOwp9CmVscy50b2dnbGVUb29sYmFyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgZWxzLnRvb2xiYXIuY2xhc3NMaXN0LnRvZ2dsZSgnc2hvdycpOyB9KTsKQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudG9vbFtkYXRhLWNtZF0nKSkuZm9yRWFjaChidG49PiBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ZXhlYyhidG4uZ2V0QXR0cmlidXRlKCdkYXRhLWNtZCcpKSkpOwoKLyogQnVsbGV0cyAqLwplbHMuYnVsbGV0c0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IGV4ZWMoJ2luc2VydFVub3JkZXJlZExpc3QnKTsgc2F2ZVNvb24oKTsgfSk7CgovKiBGb250IGZhbWlseSAqLwplbHMuZm9udFNlbGVjdC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSk9PnsgaWYoZS50YXJnZXQudmFsdWUpIGV4ZWMoJ2ZvbnROYW1lJywgZS50YXJnZXQudmFsdWUpOyBlLnRhcmdldC52YWx1ZT0nJzsgfSk7CgovKiBGb250IHNpemUgKi8KZWxzLmZvbnRTaXplU2VsZWN0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpPT57CiAgY29uc3QgcHggPSArZWxzLmZvbnRTaXplU2VsZWN0LnZhbHVlOyBpZighcHgpIHJldHVybjsKICBhcHBseUZvbnRTaXplVG9TZWxlY3Rpb24ocHgpOwogIGVscy5mb250U2l6ZVNlbGVjdC52YWx1ZT0nJzsKfSk7CmZ1bmN0aW9uIGFwcGx5Rm9udFNpemVUb1NlbGVjdGlvbihweCl7CiAgY29uc3Qgc2VsID0gd2luZG93LmdldFNlbGVjdGlvbigpOwogIGlmKCFzZWwgfHwgc2VsLnJhbmdlQ291bnQ9PT0wKXsgZWxzLmVkaXRvci5mb2N1cygpOyByZXR1cm47IH0KICBjb25zdCByYW5nZSA9IHNlbC5nZXRSYW5nZUF0KDApOwogIGlmKCFlbHMuZWRpdG9yLmNvbnRhaW5zKHJhbmdlLmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyKSkgeyBlbHMuZWRpdG9yLmZvY3VzKCk7IHJldHVybjsgfQoKICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKHJhbmdlLmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyLCBOb2RlRmlsdGVyLlNIT1dfVEVYVCB8IE5vZGVGaWx0ZXIuU0hPV19FTEVNRU5ULCB7CiAgICBhY2NlcHROb2RlKG5vZGUpewogICAgICBpZihub2RlLm5vZGVUeXBlPT09MSAmJiAhcmFuZ2UuaW50ZXJzZWN0c05vZGUobm9kZSkpIHJldHVybiBOb2RlRmlsdGVyLkZJTFRFUl9SRUpFQ1Q7CiAgICAgIGlmKG5vZGUubm9kZVR5cGU9PT0zKXsKICAgICAgICBpZihub2RlLnRleHRDb250ZW50LnRyaW0oKT09PScnKSByZXR1cm4gTm9kZUZpbHRlci5GSUxURVJfUkVKRUNUOwogICAgICAgIHJldHVybiByYW5nZS5pbnRlcnNlY3RzTm9kZShub2RlKSA/IE5vZGVGaWx0ZXIuRklMVEVSX0FDQ0VQVCA6IE5vZGVGaWx0ZXIuRklMVEVSX1JFSkVDVDsKICAgICAgfQogICAgICBpZihub2RlLm5vZGVUeXBlPT09MSkgcmV0dXJuIHJhbmdlLmludGVyc2VjdHNOb2RlKG5vZGUpID8gTm9kZUZpbHRlci5GSUxURVJfU0tJUCA6IE5vZGVGaWx0ZXIuRklMVEVSX1JFSkVDVDsKICAgIH0KICB9KTsKICBjb25zdCB0b3VjaGVkID0gbmV3IFNldCgpOwogIHdoaWxlKHdhbGtlci5uZXh0Tm9kZSgpKXsKICAgIGNvbnN0IG4gPSB3YWxrZXIuY3VycmVudE5vZGU7CiAgICBpZihuLm5vZGVUeXBlPT09Myl7CiAgICAgIGxldCBlbCA9IG4ucGFyZW50RWxlbWVudDsKICAgICAgaWYoIWVsIHx8IGVsPT09ZWxzLmVkaXRvcil7CiAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsgc3Bhbi5zdHlsZS5mb250U2l6ZSA9IHB4KydweCc7CiAgICAgICAgcmFuZ2Uuc3Vycm91bmRDb250ZW50cyhzcGFuKTsKICAgICAgICB0b3VjaGVkLmFkZChzcGFuKTsKICAgICAgICBicmVhazsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbC5zdHlsZS5mb250U2l6ZSA9IHB4KydweCc7CiAgICAgICAgdG91Y2hlZC5hZGQoZWwpOwogICAgICB9CiAgICB9CiAgfQogIGlmKHRvdWNoZWQuc2l6ZT09PTApewogICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ3N0eWxlV2l0aENTUycsIGZhbHNlLCB0cnVlKTsKICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCdmb250U2l6ZScsIGZhbHNlLCA3KTsKICAgIGVscy5lZGl0b3IucXVlcnlTZWxlY3RvckFsbCgnZm9udFtzaXplPSI3Il0nKS5mb3JFYWNoKGY9PnsKICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgc3Bhbi5zdHlsZS5mb250U2l6ZSA9IHB4KydweCc7CiAgICAgIHNwYW4uaW5uZXJIVE1MID0gZi5pbm5lckhUTUw7IGYucmVwbGFjZVdpdGgoc3Bhbik7CiAgICB9KTsKICB9CiAgZWxzLmVkaXRvci5mb2N1cygpOwogIHNhdmVTb29uKCk7Cn0KCi8qIEhpZ2hsaWdodCBzZWxlY3Rpb24gKi8KZnVuY3Rpb24gYXBwbHlIaWdobGlnaHQoKXsKICBjb25zdCBjb2xvciA9IGVscy5oaWdobGlnaHRDb2xvci52YWx1ZSB8fCAnI2ZmZjU5ZCc7CiAgY29uc3QgY21kID0gZG9jdW1lbnQucXVlcnlDb21tYW5kU3VwcG9ydGVkKCdoaWxpdGVDb2xvcicpID8gJ2hpbGl0ZUNvbG9yJyA6ICdiYWNrQ29sb3InOwogIGRvY3VtZW50LmV4ZWNDb21tYW5kKGNtZCwgZmFsc2UsIGNvbG9yKTsKICBlbHMuZWRpdG9yLmZvY3VzKCk7Cn0KZWxzLmhpZ2hsaWdodEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFwcGx5SGlnaGxpZ2h0KTsKCi8qIEluc2VydCBjaGVja2JveCAqLwplbHMuY2hlY2tib3hCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+ewogIGNvbnN0IGJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgYm94LnR5cGUgPSAnY2hlY2tib3gnOwogIGJveC5zdHlsZS5tYXJnaW5SaWdodCA9ICc4cHgnOwogIGNvbnN0IHJhbmdlID0gd2luZG93LmdldFNlbGVjdGlvbigpLmdldFJhbmdlQXQoMCk7CiAgcmFuZ2UuaW5zZXJ0Tm9kZShib3gpOwogIHJhbmdlLnNldFN0YXJ0QWZ0ZXIoYm94KTsgcmFuZ2Uuc2V0RW5kQWZ0ZXIoYm94KTsKICBjb25zdCBzZWwgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7IHNlbC5yZW1vdmVBbGxSYW5nZXMoKTsgc2VsLmFkZFJhbmdlKHJhbmdlKTsKICBlbHMuZWRpdG9yLmZvY3VzKCk7CiAgcGVyc2lzdENoZWNrYm94U3RhdGUoYm94KTsKfSk7CgpbJ2tleXVwJywnbW91c2V1cCddLmZvckVhY2goZXY9PiBlbHMuZWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoZXYsIHVwZGF0ZVRvZ2dsZVN0YXRlKSk7CmVscy5lZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKT0+ewogIGlmKGUua2V5PT09J1RhYicpeyBlLnByZXZlbnREZWZhdWx0KCk7IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdpbnNlcnRIVE1MJywgZmFsc2UsICcmbmJzcDsmbmJzcDsmbmJzcDsmbmJzcDsnKTsgfQp9KTsKCi8qID09PT09IEZ1bGxzY3JlZW4gPT09PT0gKi8KZWxzLmZzQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICB0cnl7CiAgICBpZighZG9jdW1lbnQuZnVsbHNjcmVlbkVsZW1lbnQpewogICAgICBhd2FpdCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgZWxzLmZzQnRuLnRleHRDb250ZW50ID0gJ/CfobggRXhpdCc7CiAgICB9IGVsc2UgewogICAgICBhd2FpdCBkb2N1bWVudC5leGl0RnVsbHNjcmVlbigpOwogICAgICBlbHMuZnNCdG4udGV4dENvbnRlbnQgPSAn4pu2IEZ1bGxzY3JlZW4nOwogICAgfQogIH1jYXRjaChlcnIpeyBjb25zb2xlLmVycm9yKGVycik7IGFsZXJ0KCdGdWxsc2NyZWVuIG5vdCBzdXBwb3J0ZWQgaGVyZS4nKTsgfQp9KTsKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZScsICgpPT57CiAgaWYoIWRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50KSBlbHMuZnNCdG4udGV4dENvbnRlbnQ9J+KbtiBGdWxsc2NyZWVuJzsKfSk7CgovKiA9PT09PSBQb3BvdmVycyA9PT09PSAqLwpmdW5jdGlvbiBvcGVuUG9wb3Zlcihwb3ApeyBjbG9zZUFsbFBvcG92ZXJzKHBvcCk7IHBvcC5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7IH0KZnVuY3Rpb24gY2xvc2VBbGxQb3BvdmVycyhleGNlcHQpeyBbZWxzLmFpUG9wb3ZlciwgZWxzLmRyYXdQb3BvdmVyLCBlbHMuZG93bmxvYWRQb3BvdmVyLCBlbHMucmVtaW5kZXJQb3BvdmVyLCBlbHMucmVtTWdyXS5mb3JFYWNoKHA9PnsgaWYocCAmJiBwIT09ZXhjZXB0KSBwLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsgfSk7IH0KCmVscy5kb3dubG9hZEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+eyBlLnN0b3BQcm9wYWdhdGlvbigpOyBvcGVuUG9wb3ZlcihlbHMuZG93bmxvYWRQb3BvdmVyKTsgfSk7CmVscy5kbENhbmNlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT4gZWxzLmRvd25sb2FkUG9wb3Zlci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93JykpOwoKLyogPT09PT0gUERGIChXWVNJV1lHKSA9PT09PSAqLwplbHMuZGxHby5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpPT57CiAgY29uc3Qgc2NvcGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPSJkbC1zY29wZSJdOmNoZWNrZWQnKS52YWx1ZTsgLy8gcGFnZSB8IGFsbAogIGVscy5kb3dubG9hZFBvcG92ZXIuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwogIHRyeXsKICAgIGNvbnN0IGhhbmRsZSA9IGF3YWl0IHdpbmRvdy5zaG93U2F2ZUZpbGVQaWNrZXIoewogICAgICBzdWdnZXN0ZWROYW1lOiAnUmFtTm90ZXMucGRmJywKICAgICAgdHlwZXM6IFt7IGRlc2NyaXB0aW9uOidQREYnLCBhY2NlcHQ6eyAnYXBwbGljYXRpb24vcGRmJzpbJy5wZGYnXSB9IH1dCiAgICB9KTsKCiAgICBjb25zdCB7IGpzUERGIH0gPSB3aW5kb3cuanNwZGY7CiAgICBjb25zdCBwYWdlcyA9IChzY29wZT09PSdhbGwnKSA/IGNvbGxlY3RBbGxOb3RlTm9kZXMoKSA6IGNvbGxlY3RDdXJyZW50Tm90ZU5vZGUoKTsKCiAgICBjb25zdCBkb2MgPSBuZXcganNQREYoeyB1bml0OidweCcsIGZvcm1hdDonYTQnIH0pOwogICAgbGV0IGZpcnN0ID0gdHJ1ZTsKCiAgICBmb3IoY29uc3Qgbm9kZSBvZiBwYWdlcyl7CiAgICAgIGNvbnN0IGNhbnZhcyA9IGF3YWl0IHJlbmRlck5vZGUobm9kZSk7CiAgICAgIGNvbnN0IGltZ0RhdGEgPSBjYW52YXMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTsKICAgICAgY29uc3QgcGFnZVdpZHRoID0gZG9jLmludGVybmFsLnBhZ2VTaXplLmdldFdpZHRoKCk7CiAgICAgIGNvbnN0IHBhZ2VIZWlnaHQgPSBkb2MuaW50ZXJuYWwucGFnZVNpemUuZ2V0SGVpZ2h0KCk7CgogICAgICBjb25zdCByYXRpbyA9IHBhZ2VXaWR0aCAvIGNhbnZhcy53aWR0aDsKICAgICAgY29uc3QgaW1nSCA9IGNhbnZhcy5oZWlnaHQgKiByYXRpbzsKCiAgICAgIGlmKCFmaXJzdCkgZG9jLmFkZFBhZ2UoKTsKICAgICAgZmlyc3QgPSBmYWxzZTsKCiAgICAgIGlmKGltZ0ggPD0gcGFnZUhlaWdodCl7CiAgICAgICAgZG9jLmFkZEltYWdlKGltZ0RhdGEsICdQTkcnLCAwLCAwLCBwYWdlV2lkdGgsIGltZ0gpOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCB5ID0gMDsKICAgICAgICBjb25zdCBzbGljZUggPSBNYXRoLmZsb29yKHBhZ2VIZWlnaHQgLyByYXRpbyk7CiAgICAgICAgd2hpbGUoeSA8IGNhbnZhcy5oZWlnaHQpewogICAgICAgICAgY29uc3Qgc2xpY2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgIHNsaWNlLndpZHRoID0gY2FudmFzLndpZHRoOwogICAgICAgICAgc2xpY2UuaGVpZ2h0ID0gTWF0aC5taW4oc2xpY2VILCBjYW52YXMuaGVpZ2h0IC0geSk7CiAgICAgICAgICBjb25zdCBzY3R4ID0gc2xpY2UuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgIHNjdHguZHJhd0ltYWdlKGNhbnZhcywgMCwgeSwgY2FudmFzLndpZHRoLCBzbGljZS5oZWlnaHQsIDAsIDAsIGNhbnZhcy53aWR0aCwgc2xpY2UuaGVpZ2h0KTsKICAgICAgICAgIGNvbnN0IHNEYXRhID0gc2xpY2UudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTsKICAgICAgICAgIGlmKHk+MCkgZG9jLmFkZFBhZ2UoKTsKICAgICAgICAgIGRvYy5hZGRJbWFnZShzRGF0YSwgJ1BORycsIDAsIDAsIHBhZ2VXaWR0aCwgKHNsaWNlLmhlaWdodCAqIHJhdGlvKSk7CiAgICAgICAgICB5ICs9IHNsaWNlSDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBibG9iID0gZG9jLm91dHB1dCgnYmxvYicpOwogICAgY29uc3Qgd3JpdGFibGUgPSBhd2FpdCBoYW5kbGUuY3JlYXRlV3JpdGFibGUoKTsgYXdhaXQgd3JpdGFibGUud3JpdGUoYmxvYik7IGF3YWl0IHdyaXRhYmxlLmNsb3NlKCk7CiAgfWNhdGNoKGVycil7IGlmKGVycj8ubmFtZSE9PSdBYm9ydEVycm9yJyl7IGNvbnNvbGUuZXJyb3IoZXJyKTsgYWxlcnQoJ0NvdWxkIG5vdCBzYXZlIFBERi4nKTsgfSB9Cn0pOwoKZnVuY3Rpb24gY29sbGVjdEFsbE5vdGVOb2RlcygpewogIGNvbnN0IG91dCA9IFtdOwogIHdvcmtzcGFjZXMuZm9yRWFjaCh3cz0+ewogICAgb3V0LnB1c2gobWFrZVJlbmRlck5vZGUod3MsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVRpdGxlKHdzKSkgfHwgd3MsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleU5vdGUod3MpKXx8JycsIEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5SW5rKHdzKSl8fCdbXScpKSk7CiAgICBjb25zdCBzdWJzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlTdWJzKHdzKSl8fCdbXScpOwogICAgc3Vicy5mb3JFYWNoKHN1Yj0+ewogICAgICBjb25zdCBpZCA9IGAke3dzfTo6JHtzdWJ9YDsKICAgICAgb3V0LnB1c2gobWFrZVJlbmRlck5vZGUoaWQsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVRpdGxlKGlkKSkgfHwgaWQsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleU5vdGUoaWQpKXx8JycsIEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5SW5rKGlkKSl8fCdbXScpKSk7CiAgICB9KTsKICB9KTsKICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIGNvbGxlY3RDdXJyZW50Tm90ZU5vZGUoKXsKICByZXR1cm4gWyBtYWtlUmVuZGVyTm9kZShjdXJyZW50V29ya3NwYWNlLCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlUaXRsZShjdXJyZW50V29ya3NwYWNlKSkgfHwgY3VycmVudFdvcmtzcGFjZSwgbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5Tm90ZShjdXJyZW50V29ya3NwYWNlKSl8fCcnLCBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleUluayhjdXJyZW50V29ya3NwYWNlKSl8fCdbXScpKSBdOwp9Ci8qIEJ1aWxkIGEgaGlkZGVuIG5vZGUgc3R5bGVkIGxpa2UgdGhlIGVkaXRvciwgY29tcG9zaXRlIGluayBzdHJva2VzIG9uIHRvcCAqLwpmdW5jdGlvbiBtYWtlUmVuZGVyTm9kZShpZCwgdGl0bGUsIGh0bWwsIGlua1N0cm9rZXMpewogIGNvbnN0IHdyYXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICB3cmFwLnN0eWxlLmNzc1RleHQgPSAnd2lkdGg6ODAwcHg7IHBhZGRpbmc6MjBweDsgY29sb3I6JytnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmJvZHkpLmdldFByb3BlcnR5VmFsdWUoJy0tdGV4dCcpKyc7IGZvbnQtZmFtaWx5OicrZ2V0Q29tcHV0ZWRTdHlsZShlbHMuZWRpdG9yKS5mb250RmFtaWx5Kyc7IGJhY2tncm91bmQ6JytnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmJvZHkpLmdldFByb3BlcnR5VmFsdWUoJy0tYmctMicpKyc7JzsKICBjb25zdCBoZWFkaW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgaGVhZGluZy5zdHlsZS5jc3NUZXh0PSdmb250LXdlaWdodDo4MDA7IGZvbnQtc2l6ZToyMHB4OyBjb2xvcjonK2dldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuYm9keSkuZ2V0UHJvcGVydHlWYWx1ZSgnLS1hY2NlbnQnKSsnOyBtYXJnaW4tYm90dG9tOjEwcHgnOwogIGhlYWRpbmcudGV4dENvbnRlbnQgPSAodGl0bGUgfHwgJ1VudGl0bGVkJyk7CiAgY29uc3QgYm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgYm94LnN0eWxlLmNzc1RleHQgPSBnZXRDb21wdXRlZFN0eWxlKGVscy5lZGl0b3IpLmNzc1RleHQgfHwgJ3BhZGRpbmc6MTZweDsgYm9yZGVyLXJhZGl1czoxNHB4OyBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LC4wNCk7IGJvcmRlcjoxcHggc29saWQgcmdiYSgyNTUsMjU1LDI1NSwuMTgpOyc7CiAgYm94LnN0eWxlLm1pbkhlaWdodCA9ICdhdXRvJzsKICBib3guaW5uZXJIVE1MID0gaHRtbDsKCiAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgY2FudmFzLndpZHRoID0gNzYwOyBjYW52YXMuaGVpZ2h0ID0gMTA7CgogIHdyYXAuYXBwZW5kQ2hpbGQoaGVhZGluZyk7CiAgd3JhcC5hcHBlbmRDaGlsZChib3gpOwogIHdyYXAuYXBwZW5kQ2hpbGQoY2FudmFzKTsKICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHdyYXApOwogIHdyYXAuc3R5bGUucG9zaXRpb249J2ZpeGVkJzsgd3JhcC5zdHlsZS5sZWZ0PSctOTk5OTlweCc7CgogIGNvbnN0IHJlY3QgPSBib3guZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgY29uc3QgZHByID0gTWF0aC5tYXgoMSwgd2luZG93LmRldmljZVBpeGVsUmF0aW98fDEpOwogIGNhbnZhcy53aWR0aCA9IE1hdGguZmxvb3IocmVjdC53aWR0aCAqIGRwcik7CiAgY2FudmFzLmhlaWdodCA9IE1hdGguZmxvb3IocmVjdC5oZWlnaHQgKiBkcHIpOwoKICBpZihpbmtTdHJva2VzICYmIGlua1N0cm9rZXMubGVuZ3RoKXsKICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgaW5rU3Ryb2tlcy5mb3JFYWNoKHM9PnsKICAgICAgaWYocy5wb2ludHMubGVuZ3RoPDIpIHJldHVybjsKICAgICAgY3R4LmxpbmVDYXA9J3JvdW5kJzsgY3R4LmxpbmVKb2luPSdyb3VuZCc7CiAgICAgIGlmKHMubW9kZT09PSdlcmFzZXInKXsgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbj0nZGVzdGluYXRpb24tb3V0JzsgY3R4LnN0cm9rZVN0eWxlPSdyZ2JhKDAsMCwwLDEpJzsgfQogICAgICBlbHNlIHsgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbj0nc291cmNlLW92ZXInOyBjdHguc3Ryb2tlU3R5bGU9cy5jb2xvcjsgfQogICAgICBjdHgubGluZVdpZHRoID0gKHMuc2l6ZXx8NikgKiBkcHI7CiAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgZm9yKGxldCBpPTE7aTxzLnBvaW50cy5sZW5ndGg7aSsrKXsKICAgICAgICBjb25zdCBhPXMucG9pbnRzW2ktMV0sIGI9cy5wb2ludHNbaV07CiAgICAgICAgY3R4Lm1vdmVUbyhhLngsIGEueSk7IGN0eC5saW5lVG8oYi54LCBiLnkpOwogICAgICB9CiAgICAgIGN0eC5zdHJva2UoKTsKICAgIH0pOwogICAgY29uc3Qgb3ZlcmxheSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgb3ZlcmxheS5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKTsKICAgIG92ZXJsYXkuc3R5bGUuY3NzVGV4dD0ncG9zaXRpb246YWJzb2x1dGU7IGluc2V0OjA7IHdpZHRoOjEwMCU7IGhlaWdodDoxMDAlOyBib3JkZXItcmFkaXVzOjE0cHg7IHBvaW50ZXItZXZlbnRzOm5vbmUnOwogICAgYm94LnN0eWxlLnBvc2l0aW9uPSdyZWxhdGl2ZSc7CiAgICBib3guYXBwZW5kQ2hpbGQob3ZlcmxheSk7CiAgfQogIHJldHVybiB3cmFwOwp9CmFzeW5jIGZ1bmN0aW9uIHJlbmRlck5vZGUobm9kZSl7CiAgY29uc3QgY2FudmFzID0gYXdhaXQgaHRtbDJjYW52YXMobm9kZSwgeyBzY2FsZToyLCBiYWNrZ3JvdW5kQ29sb3I6bnVsbCwgdXNlQ09SUzp0cnVlLCBsb2dnaW5nOmZhbHNlIH0pOwogIG5vZGUucmVtb3ZlKCk7CiAgcmV0dXJuIGNhbnZhczsKfQoKLyogPT09PT0gVmVyc2lvbmluZyA9PT09PSAqLwplbHMucmV2ZXJ0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICBjb25zdCBoayA9IGtleUhpc3QoY3VycmVudFdvcmtzcGFjZSk7CiAgY29uc3QgaGlzdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oaGspIHx8ICdbXScpOwogIGlmKGhpc3QubGVuZ3RoPDIpeyBhbGVydCgnTm8gcHJldmlvdXMgdmVyc2lvbnMgdG8gcmV2ZXJ0LicpOyByZXR1cm47IH0KICBoaXN0LnBvcCgpOwogIGNvbnN0IHByZXYgPSBoaXN0W2hpc3QubGVuZ3RoLTFdOwogIGVscy5lZGl0b3IuaW5uZXJIVE1MID0gcHJldjsKICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXlOb3RlKGN1cnJlbnRXb3Jrc3BhY2UpLCBwcmV2KTsKICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShoaywgSlNPTi5zdHJpbmdpZnkoaGlzdCkpOwogIGVscy5zdGF0dXMudGV4dENvbnRlbnQ9J1JldmVydGVkJzsKfSk7CgovKiA9PT09PSBBSSBTdW1tYXJ5IChjbGllbnQtc2lkZSkgPT09PT0gKi8KZWxzLmFpQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGUuc3RvcFByb3BhZ2F0aW9uKCk7IG9wZW5Qb3BvdmVyKGVscy5haVBvcG92ZXIpOyB9KTsKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICBpZihlbHMuYWlQb3BvdmVyICYmICFlbHMuYWlQb3BvdmVyLmNvbnRhaW5zKGUudGFyZ2V0KSAmJiBlLnRhcmdldCE9PWVscy5haUJ0bikgZWxzLmFpUG9wb3Zlci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7CiAgaWYoZWxzLmRyYXdQb3BvdmVyICYmICFlbHMuZHJhd1BvcG92ZXIuY29udGFpbnMoZS50YXJnZXQpICYmIGUudGFyZ2V0IT09ZWxzLmRyYXdUb2dnbGUpIGVscy5kcmF3UG9wb3Zlci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7CiAgaWYoZWxzLmRvd25sb2FkUG9wb3ZlciAmJiAhZWxzLmRvd25sb2FkUG9wb3Zlci5jb250YWlucyhlLnRhcmdldCkgJiYgZS50YXJnZXQhPT1lbHMuZG93bmxvYWRCdG4pIGVscy5kb3dubG9hZFBvcG92ZXIuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwogIGlmKGVscy5yZW1pbmRlclBvcG92ZXIgJiYgIWVscy5yZW1pbmRlclBvcG92ZXIuY29udGFpbnMoZS50YXJnZXQpICYmIGUudGFyZ2V0IT09ZWxzLnJlbWluZGVyQnRuKSBlbHMucmVtaW5kZXJQb3BvdmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsKICBpZihlbHMucmVtTWdyICYmICFlbHMucmVtTWdyLmNvbnRhaW5zKGUudGFyZ2V0KSAmJiBlLnRhcmdldCE9PWVscy5yZW1NYW5hZ2UpIGVscy5yZW1NZ3IuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwp9KTsKZWxzLnN1bUxlbi5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKT0+IGVscy5jdXN0b21Sb3cuc3R5bGUuZGlzcGxheSA9IChlbHMuc3VtTGVuLnZhbHVlPT09J2N1c3RvbScgPyAnZmxleCcgOiAnbm9uZScpKTsKZWxzLnN1bVBjdC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpPT4gZWxzLnN1bVBjdFZhbC50ZXh0Q29udGVudCA9IGVscy5zdW1QY3QudmFsdWUgKyAnJScpOwplbHMuc3VtU2VsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnJ1blN1bW1hcnkodHJ1ZSkpOwplbHMuc3VtQWxsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnJ1blN1bW1hcnkoZmFsc2UpKTsKCmZ1bmN0aW9uIHJ1blN1bW1hcnkoc2VsZWN0aW9uT25seSl7CiAgY29uc3Qgc2VsID0gd2luZG93LmdldFNlbGVjdGlvbigpOwogIGNvbnN0IGluRWRpdG9yID0gc2VsICYmIHNlbC5yYW5nZUNvdW50ICYmIGVscy5lZGl0b3IuY29udGFpbnMoc2VsLmFuY2hvck5vZGUpOwogIGNvbnN0IHNvdXJjZSA9IChzZWxlY3Rpb25Pbmx5ICYmIGluRWRpdG9yICYmICFzZWwuaXNDb2xsYXBzZWQpID8gc2VsLnRvU3RyaW5nKCkgOiBzdHJpcEh0bWwoZWxzLmVkaXRvci5pbm5lckhUTUwpOwogIGlmKCFzb3VyY2UudHJpbSgpKXsgYWxlcnQoJ05vIHRleHQgdG8gc3VtbWFyaXplLicpOyByZXR1cm47IH0KICBjb25zdCBtb2RlID0gZWxzLnN1bUxlbi52YWx1ZT09PSdjdXN0b20nID8gJ2N1c3RvbScgOiBlbHMuc3VtTGVuLnZhbHVlOwogIGNvbnN0IHBjdCA9ICtlbHMuc3VtUGN0LnZhbHVlOwogIGNvbnN0IHJlcyA9IHN1bW1hcml6ZShzb3VyY2UsIHttb2RlLCBjdXN0b21Vbml0czoncGVyY2VudCcsIGN1c3RvbUFtb3VudDpwY3R9KTsKICBsZXQgb3V0ID0gcmVzLnN1bW1hcnk7CiAgaWYoZWxzLnN1bUJ1bGxldHMuY2hlY2tlZCkgb3V0ID0gb3V0LnNwbGl0KC8oPzw9Wy4hP10pXHMrLykuZmlsdGVyKEJvb2xlYW4pLm1hcChzPT4n4oCiICcrcykuam9pbignXG4nKTsKICBpbnNlcnRTdW1tYXJ5QmxvY2sob3V0KTsKICBlbHMuYWlQb3BvdmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsKfQpmdW5jdGlvbiBpbnNlcnRTdW1tYXJ5QmxvY2soc3VtbWFyeSl7CiAgY29uc3QgYmxvY2sgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICBibG9jay5zdHlsZS5jc3NUZXh0PSdib3JkZXItbGVmdDo0cHggc29saWQgdmFyKC0tYWNjZW50KTsgcGFkZGluZzoxMHB4IDEycHg7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDUpOyBib3JkZXItcmFkaXVzOjEycHg7IG1hcmdpbjoxMHB4IDA7JzsKICBibG9jay5pbm5lckhUTUwgPSBgPHN0cm9uZz5TdW1tYXJ5PC9zdHJvbmc+PGJyLz48cHJlIHN0eWxlPSJtYXJnaW46OHB4IDAgMDsgd2hpdGUtc3BhY2U6cHJlLXdyYXAiPiR7ZXNjYXBlSHRtbChzdW1tYXJ5KX08L3ByZT5gOwogIGNvbnN0IHJhbmdlID0gd2luZG93LmdldFNlbGVjdGlvbigpLnJhbmdlQ291bnQgPyB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkuZ2V0UmFuZ2VBdCgwKSA6IG51bGw7CiAgaWYocmFuZ2UgJiYgZWxzLmVkaXRvci5jb250YWlucyhyYW5nZS5jb21tb25BbmNlc3RvckNvbnRhaW5lcikpewogICAgcmFuZ2UuY29sbGFwc2UoZmFsc2UpOyByYW5nZS5pbnNlcnROb2RlKGJsb2NrKTsKICB9IGVsc2UgeyBlbHMuZWRpdG9yLmFwcGVuZENoaWxkKGJsb2NrKTsgfQogIGNvbnN0IHNwYWNlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBzcGFjZXIuaW5uZXJIVE1MID0gJzxiciAvPic7CiAgYmxvY2suYWZ0ZXIoc3BhY2VyKTsKICBwbGFjZUNhcmV0QXRFbmQoc3BhY2VyKTsKICBzYXZlU29vbigpOwp9CmZ1bmN0aW9uIHBsYWNlQ2FyZXRBdEVuZChub2RlKXsKICBjb25zdCByYW5nZSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7IGNvbnN0IHNlbCA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTsKICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHMobm9kZSk7IHJhbmdlLmNvbGxhcHNlKGZhbHNlKTsKICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7IHNlbC5hZGRSYW5nZShyYW5nZSk7CiAgZWxzLmVkaXRvci5mb2N1cygpOwp9CmZ1bmN0aW9uIGVzY2FwZUh0bWwocyl7IHJldHVybiBzLnJlcGxhY2UoL1smPD4iJ10vZywgbT0+KHsgJyYnOicmYW1wOycsJzwnOicmbHQ7JywnPic6JyZndDsnLCciJzonJnF1b3Q7JywnXCcnOicmIzM5OycgfVttXSkpOyB9Ci8qIEV4dHJhY3RpdmUgc3VtbWFyaXplciAqLwpmdW5jdGlvbiBzdW1tYXJpemUodGV4dCx7bW9kZT0nbWVkaXVtJywgY3VzdG9tVW5pdHM9J3BlcmNlbnQnLCBjdXN0b21BbW91bnQ9MzV9PXt9KXsKICBjb25zdCBzdG9wID0gbmV3IFNldCgoImEgYWJvdXQgYWJvdmUgYWZ0ZXIgYWdhaW4gYWdhaW5zdCBhbGwgYW0gYW4gYW5kIGFueSBhcmUgYXJlbid0IGFzIGF0IGJlIGJlY2F1c2UgYmVlbiBiZWZvcmUgYmVpbmcgYmVsb3cgIisKICAiYmV0d2VlbiBib3RoIGJ1dCBieSBjYW4ndCBjYW5ub3QgY291bGQgY291bGRuJ3QgZGlkIGRpZG4ndCBkbyBkb2VzIGRvZXNuJ3QgZG9pbmcgZG9uJ3QgZG93biBkdXJpbmcgZWFjaCBmZXcgZm9yIGZyb20gZnVydGhlciBoYWQgIisKICAiaGFkbid0IGhhcyBoYXNuJ3QgaGF2ZSBoYXZlbid0IGhhdmluZyBoZSBoZSdkIGhlJ2xsIGhlJ3MgaGVyIGhlcmUgaGVyZSdzIGhlcnMgaGVyc2VsZiBoaW0gaGltc2VsZiBoaXMgaG93IGhvdydzIGkgaSdkIGknbGwgaSdtIGkndmUgIisKICAiaWYgaW4gaW50byBpcyBpc24ndCBpdCBpdCdzIGl0cyBpdHNlbGYgbGV0J3MgbWUgbW9yZSBtb3N0IG11c3RuJ3QgbXkgbXlzZWxmIG5vIG5vciBub3Qgb2Ygb2ZmIG9uIG9uY2Ugb25seSBvciBvdGhlciBvdWdodCBvdXIgb3VycyAiKwogICJvdXJzZWx2ZXMgb3V0IG92ZXIgb3duIHNhbWUgc2hhbid0IHNoZSBzaGUnZCBzaGUnbGwgc2hlJ3Mgc2hvdWxkIHNob3VsZG4ndCBzbyBzb21lIHN1Y2ggdGhhbiB0aGF0IHRoYXQncyB0aGUgdGhlaXIgdGhlaXJzIHRoZW0gIisKICAidGhlbXNlbHZlcyB0aGVuIHRoZXJlIHRoZXJlJ3MgdGhlc2UgdGhleSB0aGV5J2QgdGhleSdsbCB0aGV5J3JlIHRoZXkndmUgdGhpcyB0aG9zZSB0aHJvdWdoIHRvIHRvbyB1bmRlciB1bnRpbCB1cCB2ZXJ5IHdhcyB3YXNuJ3Qgd2UgIisKICAid2UnZCB3ZSdsbCB3ZSdyZSB3ZSd2ZSB3ZXJlIHdlcmVuJ3Qgd2hhdCB3aGF0J3Mgd2hlbiB3aGVuJ3Mgd2hlcmUgd2hlcmUncyB3aGljaCB3aGlsZSB3aG8gd2hvJ3Mgd2hvbSB3aHkgd2h5J3Mgd2l0aCB3b24ndCB3b3VsZCAiKwogICJ3b3VsZG4ndCB5b3UgeW91J2QgeW91J2xsIHlvdSdyZSB5b3UndmUgeW91ciB5b3VycyB5b3Vyc2VsZiB5b3Vyc2VsdmVzIikuc3BsaXQoL1xzKy8pKTsKICBjb25zdCBzZW50U3BsaXQgPSAodCk9PiB0LnJlcGxhY2UoL1xzKy9nLCcgJykubWF0Y2goL1teLiE/XG5ccl0rWy4hP10/L2cpfHxbXTsKICBjb25zdCB0b2tlbml6ZSA9IChzKT0+IHMudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bXmEtejAtOVxzJ10vZ2ksJyAnKS5zcGxpdCgvXHMrLykuZmlsdGVyKHc9PncgJiYgIXN0b3AuaGFzKHcpKTsKICBjb25zdCBzZW50ZW5jZXMgPSBzZW50U3BsaXQodGV4dCkubWFwKHM9PnMudHJpbSgpKS5maWx0ZXIoQm9vbGVhbik7CiAgaWYoIXNlbnRlbmNlcy5sZW5ndGgpIHJldHVybiB7c3VtbWFyeTonJywgc2VudGVuY2VzOltdLCBzZWxlY3RlZDpbXX07CiAgY29uc3QgZnJlcSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdG9rZW5pemUodGV4dCkuZm9yRWFjaCh3PT5mcmVxW3ddPShmcmVxW3ddfHwwKSsxKTsKICBjb25zdCBtYXggPSBNYXRoLm1heCgxLCAuLi5PYmplY3QudmFsdWVzKGZyZXEpKTsgT2JqZWN0LmtleXMoZnJlcSkuZm9yRWFjaChrPT5mcmVxW2tdLz1tYXgpOwogIGNvbnN0IHNjb3JlZCA9IHNlbnRlbmNlcy5tYXAoKHMsaSk9PnsKICAgIGNvbnN0IHRva3MgPSB0b2tlbml6ZShzKTsgY29uc3QgbGVuID0gTWF0aC5tYXgoMSx0b2tzLmxlbmd0aCk7CiAgICBsZXQgc2NvcmUgPSAwOyB0b2tzLmZvckVhY2godD0+c2NvcmUgKz0gKGZyZXFbdF18fDApKTsKICAgIGNvbnN0IHBvc0Jvb3N0ID0gMSArICgxIC0gKGkvTWF0aC5tYXgoMSwgc2VudGVuY2VzLmxlbmd0aC0xKSkpICogLjE1OwogICAgcmV0dXJuIHtpLCBzLCB2OihzY29yZS9sZW4pKnBvc0Jvb3N0fTsKICB9KTsKICBsZXQga2VlcDsKICBpZihbJ3Nob3J0JywnbWVkaXVtJywnbG9uZyddLmluY2x1ZGVzKG1vZGUpKXsKICAgIGtlZXAgPSBNYXRoLm1heCgxLCBNYXRoLnJvdW5kKHNlbnRlbmNlcy5sZW5ndGggKiAobW9kZT09PSdzaG9ydCc/MC4yOm1vZGU9PT0nbG9uZyc/MC41OjAuMzUpKSk7CiAgfWVsc2V7CiAgICBpZihjdXN0b21Vbml0cz09PSdwZXJjZW50Jyl7CiAgICAgIGNvbnN0IHIgPSBNYXRoLm1heCgxLCBNYXRoLm1pbigxMDAsICtjdXN0b21BbW91bnR8fDM1KSk7IGtlZXAgPSBNYXRoLm1heCgxLCBNYXRoLnJvdW5kKHNlbnRlbmNlcy5sZW5ndGgqKHIvMTAwKSkpOwogICAgfWVsc2Uga2VlcCA9IE1hdGgubWF4KDEsIE1hdGgubWluKHNlbnRlbmNlcy5sZW5ndGgsICtjdXN0b21BbW91bnR8fDMpKTsKICB9CiAgY29uc3QgdG9wID0gWy4uLnNjb3JlZF0uc29ydCgoYSxiKT0+Yi52LWEudikuc2xpY2UoMCxrZWVwKS5zb3J0KChhLGIpPT5hLmktYi5pKTsKICBjb25zdCBrZWVwSWR4ID0gbmV3IFNldCh0b3AubWFwKHg9PnguaSkpOwogIHJldHVybiB7c3VtbWFyeTogc2VudGVuY2VzLmZpbHRlcigoXyxpKT0+a2VlcElkeC5oYXMoaSkpLmpvaW4oJyAnKSwgc2VudGVuY2VzLCBzZWxlY3RlZDogdG9wfTsKfQoKLyogPT09PT0gRHJhd2luZyBvdmVybGF5ID09PT09ICovCmZ1bmN0aW9uIHJlc2l6ZUlua0NhbnZhcygpewogIGNvbnN0IHJlY3QgPSBlbHMuZWRpdG9yLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIGNvbnN0IGRwciA9IE1hdGgubWF4KDEsIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDEpOwogIGVscy5pbmsud2lkdGggPSBNYXRoLmZsb29yKHJlY3Qud2lkdGggKiBkcHIpOwogIGVscy5pbmsuaGVpZ2h0PSBNYXRoLmZsb29yKHJlY3QuaGVpZ2h0KiBkcHIpOwogIGVscy5pbmsuc3R5bGUud2lkdGggPSByZWN0LndpZHRoKydweCc7CiAgZWxzLmluay5zdHlsZS5oZWlnaHQ9IHJlY3QuaGVpZ2h0KydweCc7Cn0KZnVuY3Rpb24gZWRpdG9yUmVjdCgpeyByZXR1cm4gZWxzLmVkaXRvci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsgfQpmdW5jdGlvbiBwb2ludEZyb21FdmVudChlKXsKICBjb25zdCByZWN0ID0gZWRpdG9yUmVjdCgpOyBjb25zdCBkcHIgPSBNYXRoLm1heCgxLCB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxKTsKICByZXR1cm4geyB4OiAoZS5jbGllbnRYIC0gcmVjdC5sZWZ0KSAqIGRwciwgeTogKGUuY2xpZW50WSAtIHJlY3QudG9wKSAqIGRwciB9Owp9CmZ1bmN0aW9uIHNldERyYXdpbmcob24pewogIGRyYXdpbmdPbiA9IG9uOwogIGVscy5pbmsuc3R5bGUucG9pbnRlckV2ZW50cyA9IG9uID8gJ2F1dG8nIDogJ25vbmUnOwogIGVscy5kcmF3VG9nZ2xlLnRleHRDb250ZW50ID0gb24gPyAn4pyP77iPIERyYXdpbmcgT04nIDogJ+Kcj++4jyBEcmF3JzsKICBlbHMuZHJhd1BvcG92ZXIuY2xhc3NMaXN0LnRvZ2dsZSgnc2hvdycsIG9uKTsKfQpmdW5jdGlvbiBzdGFydFN0cm9rZShwKXsgY3VycmVudFN0cm9rZSA9IHsgbW9kZTogZHJhd01vZGUsIGNvbG9yOiBlbHMucGVuQ29sb3IudmFsdWUsIHNpemU6K2Vscy5wZW5TaXplLnZhbHVlLCBwb2ludHM6W3BdIH07IHN0cm9rZXMucHVzaChjdXJyZW50U3Ryb2tlKTsgfQpmdW5jdGlvbiBhZGRQb2ludChwKXsgaWYoIWN1cnJlbnRTdHJva2UpIHJldHVybjsgY3VycmVudFN0cm9rZS5wb2ludHMucHVzaChwKTsgZHJhd0xhc3RTZWdtZW50KGN1cnJlbnRTdHJva2UpOyB9CmZ1bmN0aW9uIGVuZFN0cm9rZSgpeyBpZighY3VycmVudFN0cm9rZSkgcmV0dXJuOyBjdXJyZW50U3Ryb2tlPW51bGw7IHBlcnNpc3RJbmsoKTsgfQoKZnVuY3Rpb24gcmVkcmF3SW5rKCl7CiAgY29uc3QgY3R4ID0gZWxzLmluay5nZXRDb250ZXh0KCcyZCcpOwogIGNvbnN0IGRwciA9IE1hdGgubWF4KDEsIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvfHwxKTsKICBjdHguY2xlYXJSZWN0KDAsMCxlbHMuaW5rLndpZHRoLCBlbHMuaW5rLmhlaWdodCk7CiAgc3Ryb2tlcy5mb3JFYWNoKHM9PmRyYXdTdHJva2UoY3R4LCBzLCBkcHIpKTsKICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ3NvdXJjZS1vdmVyJzsKICBjdHguZ2xvYmFsQWxwaGEgPSAxOwp9CmZ1bmN0aW9uIGRyYXdTdHJva2UoY3R4LCBzLCBkcHIpewogIGlmKHMucG9pbnRzLmxlbmd0aDwyKSByZXR1cm47CiAgY3R4LmxpbmVDYXA9J3JvdW5kJzsgY3R4LmxpbmVKb2luPSdyb3VuZCc7CiAgaWYocy5tb2RlPT09J2VyYXNlcicpewogICAgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbj0nZGVzdGluYXRpb24tb3V0JzsgY3R4Lmdsb2JhbEFscGhhPTE7IGN0eC5zdHJva2VTdHlsZT0ncmdiYSgwLDAsMCwxKSc7CiAgfSBlbHNlIHsKICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb249J3NvdXJjZS1vdmVyJzsgY3R4Lmdsb2JhbEFscGhhPTE7IGN0eC5zdHJva2VTdHlsZT1zLmNvbG9yOwogIH0KICBjdHgubGluZVdpZHRoID0gcy5zaXplICogZHByOwogIGN0eC5iZWdpblBhdGgoKTsKICBmb3IobGV0IGk9MTtpPHMucG9pbnRzLmxlbmd0aDtpKyspeyBjb25zdCBhPXMucG9pbnRzW2ktMV0sIGI9cy5wb2ludHNbaV07IGN0eC5tb3ZlVG8oYS54LGEueSk7IGN0eC5saW5lVG8oYi54LGIueSk7IH0KICBjdHguc3Ryb2tlKCk7Cn0KZnVuY3Rpb24gZHJhd0xhc3RTZWdtZW50KHMpewogIGNvbnN0IGN0eCA9IGVscy5pbmsuZ2V0Q29udGV4dCgnMmQnKTsgY29uc3QgZHByID0gTWF0aC5tYXgoMSwgd2luZG93LmRldmljZVBpeGVsUmF0aW98fDEpOwogIGNvbnN0IG49cy5wb2ludHMubGVuZ3RoOyBpZihuPDIpIHJldHVybjsKICBjb25zdCBzZWcgPSB7Li4ucywgcG9pbnRzOiBzLnBvaW50cy5zbGljZShuLTIpfTsKICBkcmF3U3Ryb2tlKGN0eCwgc2VnLCBkcHIpOwp9CmZ1bmN0aW9uIHBlcnNpc3RJbmsoKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5SW5rKGN1cnJlbnRXb3Jrc3BhY2UpLCBKU09OLnN0cmluZ2lmeShzdHJva2VzKSk7IH0KClsncG9pbnRlcmRvd24nLCdwb2ludGVybW92ZScsJ3BvaW50ZXJ1cCcsJ3BvaW50ZXJjYW5jZWwnLCdwb2ludGVybGVhdmUnXS5mb3JFYWNoKGV2PT57CiAgZWxzLmluay5hZGRFdmVudExpc3RlbmVyKGV2LCAoZSk9PnsKICAgIGlmKCFkcmF3aW5nT24pIHJldHVybjsKICAgIGlmKGV2PT09J3BvaW50ZXJkb3duJyl7IGVscy5pbmsuc2V0UG9pbnRlckNhcHR1cmUoZS5wb2ludGVySWQpOyBzdGFydFN0cm9rZShwb2ludEZyb21FdmVudChlKSk7IH0KICAgIGVsc2UgaWYoZXY9PT0ncG9pbnRlcm1vdmUnKXsgaWYoY3VycmVudFN0cm9rZSkgYWRkUG9pbnQocG9pbnRGcm9tRXZlbnQoZSkpOyB9CiAgICBlbHNlIHsgZW5kU3Ryb2tlKCk7IH0KICAgIGUucHJldmVudERlZmF1bHQoKTsKICB9LCB7cGFzc2l2ZTpmYWxzZX0pOwp9KTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpPT57IHJlc2l6ZUlua0NhbnZhcygpOyByZWRyYXdJbmsoKTsgfSk7Cm5ldyBSZXNpemVPYnNlcnZlcigoKT0+eyByZXNpemVJbmtDYW52YXMoKTsgcmVkcmF3SW5rKCk7IH0pLm9ic2VydmUoZWxzLmVkaXRvcik7CgovKiBEcmF3IFVJICovCmVscy5kcmF3VG9nZ2xlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGUuc3RvcFByb3BhZ2F0aW9uKCk7IHNldERyYXdpbmcoIWRyYXdpbmdPbik7IH0pOwplbHMuZXJhc2VyQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgZHJhd01vZGUgPSAoZHJhd01vZGU9PT0nZXJhc2VyJyA/ICdwZW4nIDogJ2VyYXNlcicpOyBlbHMuZXJhc2VyQnRuLnRleHRDb250ZW50ID0gZHJhd01vZGU9PT0nZXJhc2VyJyA/ICfwn5aK77iPIEVyYXNlcjogT04nIDogJ/Cfp70gRXJhc2VyOiBPZmYnOyB9KTsKZWxzLmNsZWFySW5rQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgaWYoY29uZmlybSgnQ2xlYXIgYWxsIGluayBmb3IgdGhpcyBwYWdlPycpKXsgc3Ryb2tlcz1bXTsgcmVkcmF3SW5rKCk7IHBlcnNpc3RJbmsoKTsgfSB9KTsKCi8qID09PT09IEVtYWlsIChvcGVucyBjb21wb3NlICsgY29waWVzIHJpY2ggY29udGVudCkgPT09PT0gKi8KZWxzLmVtYWlsQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAvLyAxKSBDb3B5IHJpY2ggY29udGVudCB0byBjbGlwYm9hcmQgc28gYSBwYXN0ZSBrZWVwcyBmb3JtYXR0aW5nCiAgdHJ5ewogICAgY29uc3QgaHRtbCA9IGVscy5lZGl0b3IuaW5uZXJIVE1MOwogICAgY29uc3QgdGV4dCA9IHN0cmlwSHRtbChodG1sKTsKICAgIGNvbnN0IGJsb2JIdG1sID0gbmV3IEJsb2IoW2h0bWxdLCB7dHlwZTogJ3RleHQvaHRtbCd9KTsKICAgIGNvbnN0IGJsb2JUZXh0ID0gbmV3IEJsb2IoW3RleHRdLCB7dHlwZTogJ3RleHQvcGxhaW4nfSk7CiAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlKFsKICAgICAgbmV3IENsaXBib2FyZEl0ZW0oeyAndGV4dC9odG1sJzogYmxvYkh0bWwsICd0ZXh0L3BsYWluJzogYmxvYlRleHQgfSkKICAgIF0pOwogIH1jYXRjaChlKXsgLyogaWdub3JlIGlmIGJsb2NrZWQgKi8gfQoKICAvLyAyKSBPcGVuIGRlZmF1bHQgZW1haWwgY29tcG9zZSB3aXRoIHN1YmplY3Q7IHVzZXIgcGFzdGVzIChDdHJsL0NtZCtWKSBhbmQgaXQgc3RheXMgZm9ybWF0dGVkCiAgY29uc3Qgc3ViamVjdCA9IGVuY29kZVVSSUNvbXBvbmVudChgUmFtTm90ZXMg4oCUICR7bG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5VGl0bGUoY3VycmVudFdvcmtzcGFjZSkpIHx8IGN1cnJlbnRXb3Jrc3BhY2V9YCk7CiAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBgbWFpbHRvOj9zdWJqZWN0PSR7c3ViamVjdH1gOwp9KTsKCi8qID09PT09IFJlbWluZGVycyA9PT09PSAqLwplbHMucmVtaW5kZXJCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsKICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpOyBjb25zdCBkID0gbmV3IERhdGUobm93LmdldFRpbWUoKSs2MCo2MCoxMDAwKTsKICBlbHMucmVtRGF0ZS52YWx1ZSA9IGQudG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKTsKICBlbHMucmVtVGltZS52YWx1ZSA9IGQudG9UaW1lU3RyaW5nKCkuc2xpY2UoMCw1KTsKICBlbHMucmVtTXNnLnZhbHVlID0gJyc7CiAgb3BlblBvcG92ZXIoZWxzLnJlbWluZGVyUG9wb3Zlcik7Cn0pOwplbHMucmVtQ2FuY2VsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiBlbHMucmVtaW5kZXJQb3BvdmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKSk7CmVscy5yZW1TYXZlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICBjb25zdCBkYXRlID0gZWxzLnJlbURhdGUudmFsdWU7IGNvbnN0IHRpbWUgPSBlbHMucmVtVGltZS52YWx1ZTsgY29uc3QgbXNnID0gZWxzLnJlbU1zZy52YWx1ZS50cmltKCkgfHwgJ1JlbWluZGVyJzsKICBjb25zdCBlbW9qaT0gKGVscy5yZW1FbW9qaVNlbC52YWx1ZSB8fCAn4o+wJyk7CiAgaWYoIWRhdGUgfHwgIXRpbWUpeyBhbGVydCgnUGljayBkYXRlIGFuZCB0aW1lLicpOyByZXR1cm47IH0KICBjb25zdCB3aGVuID0gcGFyc2VMb2NhbChkYXRlLCB0aW1lKTsKICBpZih3aGVuLmdldFRpbWUoKSA8PSBEYXRlLm5vdygpKXsgYWxlcnQoJ1BpY2sgYSBmdXR1cmUgdGltZS4nKTsgcmV0dXJuOyB9CiAgY29uc3QgbGlzdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5UmVtaW5kZXIoY3VycmVudFdvcmtzcGFjZSkpfHwnW10nKTsKICBsaXN0LnB1c2goeyBpZDogY3J5cHRvLnJhbmRvbVVVSUQoKSwgYXQ6IHdoZW4uZ2V0VGltZSgpLCBtc2csIGVtb2ppLCBwYWdlOiBjdXJyZW50V29ya3NwYWNlIH0pOwogIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleVJlbWluZGVyKGN1cnJlbnRXb3Jrc3BhY2UpLCBKU09OLnN0cmluZ2lmeShsaXN0KSk7CiAgZWxzLnJlbWluZGVyUG9wb3Zlci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7CiAgc2NoZWR1bGVOZXh0UmVtaW5kZXIoKTsKfSk7CgovKiBNYW5hZ2VyICovCmVscy5yZW1NYW5hZ2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgb3BlblBvcG92ZXIoZWxzLnJlbU1ncik7IHJlbmRlclJlbWluZGVyTWFuYWdlcigpOyB9KTsKZWxzLnJlbU1nckNsb3NlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiBlbHMucmVtTWdyLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKSk7CmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W25hbWU9Im1nci1zY29wZSJdJykuZm9yRWFjaChyID0+IHIuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVuZGVyUmVtaW5kZXJNYW5hZ2VyKSk7CgpmdW5jdGlvbiByZW5kZXJSZW1pbmRlck1hbmFnZXIoKXsKICBjb25zdCBzY29wZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9Im1nci1zY29wZSJdOmNoZWNrZWQnKS52YWx1ZTsgLy8gcGFnZXxhbGwKICBjb25zdCBpdGVtcyA9IChzY29wZT09PSdhbGwnKSA/IGdldEFsbFVwY29taW5nUmVtaW5kZXJzRGV0YWlsZWQoKSA6IGdldFBhZ2VVcGNvbWluZ1JlbWluZGVycyhjdXJyZW50V29ya3NwYWNlKTsKICBlbHMucmVtTWdyTGlzdC5pbm5lckhUTUwgPSAnJzsKICBpZihpdGVtcy5sZW5ndGg9PT0wKXsgZWxzLnJlbU1nckxpc3QuaW5uZXJIVE1MID0gJzxkaXYgc3R5bGU9Im9wYWNpdHk6Ljg7IHBhZGRpbmc6OHB4Ij5ObyB1cGNvbWluZyByZW1pbmRlcnMuPC9kaXY+JzsgcmV0dXJuOyB9CiAgaXRlbXMuZm9yRWFjaCgoeCk9PnsKICAgIGNvbnN0IHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyByb3cuY2xhc3NOYW1lPSdyZW0taXRlbSc7CiAgICBjb25zdCBlbW9qaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBlbW9qaS50ZXh0Q29udGVudCA9IHguZW1vamk7CiAgICBjb25zdCBtc2cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOyBtc2cuY2xhc3NOYW1lPSdzZWxlY3QnOyBtc2cudmFsdWUgPSB4Lm1zZzsgbXNnLnN0eWxlLndpZHRoPScxMDAlJzsKICAgIGNvbnN0IGRhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOyBkYXRlLnR5cGU9J2RhdGUnOyBkYXRlLmNsYXNzTmFtZT0nc2VsZWN0JzsgZGF0ZS52YWx1ZSA9IHRzVG9EYXRlKHguYXQpOwogICAgY29uc3QgdGltZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7IHRpbWUudHlwZT0ndGltZSc7IHRpbWUuY2xhc3NOYW1lPSdzZWxlY3QnOyB0aW1lLnZhbHVlID0gdHNUb1RpbWUoeC5hdCk7CiAgICBjb25zdCBwYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IHBhZ2Uuc3R5bGUub3BhY2l0eT0nLjgnOyBwYWdlLnN0eWxlLmZvbnRTaXplPScuOXJlbSc7IHBhZ2UudGV4dENvbnRlbnQgPSAoeC5wYWdlIHx8ICd0aGlzIHBhZ2UnKTsKICAgIGNvbnN0IGFjdGlvbnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgYWN0aW9ucy5jbGFzc05hbWU9J3JlbS1hY3Rpb25zJzsKICAgIGNvbnN0IHNhdmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTsgc2F2ZS5jbGFzc05hbWU9J2J0bic7IHNhdmUudGV4dENvbnRlbnQ9J1NhdmUnOwogICAgY29uc3QgZGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7IGRlbC5jbGFzc05hbWU9J2J0biBkYW5nZXInOyBkZWwudGV4dENvbnRlbnQ9J0RlbGV0ZSc7CgogICAgc2F2ZS5vbmNsaWNrID0gKCk9PnsKICAgICAgY29uc3Qgd2hlbiA9IHBhcnNlTG9jYWwoZGF0ZS52YWx1ZSwgdGltZS52YWx1ZSkuZ2V0VGltZSgpOwogICAgICB1cGRhdGVSZW1pbmRlcih4LmlkLCB7IGF0OiB3aGVuLCBtc2c6IG1zZy52YWx1ZS50cmltKCl8fCdSZW1pbmRlcicgfSk7CiAgICAgIHJlbmRlclJlbWluZGVyTWFuYWdlcigpOyBzY2hlZHVsZU5leHRSZW1pbmRlcigpOwogICAgfTsKICAgIGRlbC5vbmNsaWNrID0gKCk9PnsgZGVsZXRlUmVtaW5kZXIoeC5pZCk7IHJlbmRlclJlbWluZGVyTWFuYWdlcigpOyBzY2hlZHVsZU5leHRSZW1pbmRlcigpOyB9OwoKICAgIGFjdGlvbnMuYXBwZW5kKHNhdmUsIGRlbCk7CiAgICByb3cuYXBwZW5kKGVtb2ppLCBtc2csIGRhdGUsIHRpbWUsIHBhZ2UsIGFjdGlvbnMpOwogICAgZWxzLnJlbU1nckxpc3QuYXBwZW5kQ2hpbGQocm93KTsKICB9KTsKfQpmdW5jdGlvbiB0c1RvRGF0ZSh0cyl7IGNvbnN0IGQgPSBuZXcgRGF0ZSh0cyk7IHJldHVybiBkLnRvSVNPU3RyaW5nKCkuc2xpY2UoMCwxMCk7IH0KZnVuY3Rpb24gdHNUb1RpbWUodHMpeyBjb25zdCBkID0gbmV3IERhdGUodHMpOyByZXR1cm4gZC50b1RpbWVTdHJpbmcoKS5zbGljZSgwLDUpOyB9CmZ1bmN0aW9uIHBhcnNlTG9jYWwoZGF0ZVN0ciwgdGltZVN0cil7IHJldHVybiBuZXcgRGF0ZShkYXRlU3RyKydUJyt0aW1lU3RyKyc6MDAnKTsgfQoKZnVuY3Rpb24gc3RhcnRSZW1pbmRlclRpY2tlcigpeyBzY2hlZHVsZU5leHRSZW1pbmRlcigpOyB9CmZ1bmN0aW9uIHNjaGVkdWxlTmV4dFJlbWluZGVyKCl7CiAgaWYocmVtaW5kZXJUaW1lcikgeyBjbGVhclRpbWVvdXQocmVtaW5kZXJUaW1lcik7IHJlbWluZGVyVGltZXI9bnVsbDsgfQogIGNvbnN0IGFsbCA9IGdldEFsbFVwY29taW5nUmVtaW5kZXJzRGV0YWlsZWQoKTsKICBpZihhbGwubGVuZ3RoPT09MCkgcmV0dXJuOwogIGNvbnN0IG5leHQgPSBhbGxbMF07CiAgY29uc3QgZGVsYXkgPSBNYXRoLm1heCgwLCBuZXh0LmF0IC0gRGF0ZS5ub3coKSk7CiAgcmVtaW5kZXJUaW1lciA9IHNldFRpbWVvdXQoKCk9Pnsgc2hvd1JlbWluZGVyTW9kYWwobmV4dC5lbW9qaSwgbmV4dC5tc2cpOyBtYXJrUmVtaW5kZXJGaXJlZChuZXh0LmlkKTsgc2NoZWR1bGVOZXh0UmVtaW5kZXIoKTsgfSwgZGVsYXkpOwp9CmZ1bmN0aW9uIGdldFBhZ2VVcGNvbWluZ1JlbWluZGVycyhwYWdlSWQpewogIGNvbnN0IGxpc3QgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVJlbWluZGVyKHBhZ2VJZCkpfHwnW10nKTsKICByZXR1cm4gbGlzdC5maWx0ZXIoeD0+eC5hdD49RGF0ZS5ub3coKSkuc29ydCgoYSxiKT0+YS5hdC1iLmF0KS5tYXAoeD0+KHsuLi54LCBwYWdlOiBwYWdlSWR9KSk7Cn0KZnVuY3Rpb24gZ2V0QWxsVXBjb21pbmdSZW1pbmRlcnNEZXRhaWxlZCgpewogIGNvbnN0IGl0ZW1zPVtdOwogIHdvcmtzcGFjZXMuZm9yRWFjaCh3cz0+ewogICAgY29uc3Qgc3VicyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5U3Vicyh3cykpfHwnW10nKTsKICAgIFt3cywgLi4uc3Vicy5tYXAocz0+YCR7d3N9Ojoke3N9YCldLmZvckVhY2goaWQ9PnsKICAgICAgY29uc3QgbGlzdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5UmVtaW5kZXIoaWQpKXx8J1tdJyk7CiAgICAgIGxpc3QuZmlsdGVyKHg9PnguYXQ+PURhdGUubm93KCkpLmZvckVhY2goeD0+aXRlbXMucHVzaCh7Li4ueCwgcGFnZTppZH0pKTsKICAgIH0pOwogIH0pOwogIHJldHVybiBpdGVtcy5zb3J0KChhLGIpPT5hLmF0LWIuYXQpOwp9CmZ1bmN0aW9uIHVwZGF0ZVJlbWluZGVyKGlkLCBwYXRjaCl7CiAgd29ya3NwYWNlcy5mb3JFYWNoKHdzPT57CiAgICBjb25zdCBzdWJzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlTdWJzKHdzKSl8fCdbXScpOwogICAgW3dzLCAuLi5zdWJzLm1hcChzPT5gJHt3c306OiR7c31gKV0uZm9yRWFjaChwaWQ9PnsKICAgICAgY29uc3QgbGlzdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5UmVtaW5kZXIocGlkKSl8fCdbXScpOwogICAgICBjb25zdCBpZHggPSBsaXN0LmZpbmRJbmRleCh4PT54LmlkPT09aWQpOwogICAgICBpZihpZHg+LTEpewogICAgICAgIGxpc3RbaWR4XSA9IHsuLi5saXN0W2lkeF0sIC4uLnBhdGNofTsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXlSZW1pbmRlcihwaWQpLCBKU09OLnN0cmluZ2lmeShsaXN0KSk7CiAgICAgIH0KICAgIH0pOwogIH0pOwp9CmZ1bmN0aW9uIGRlbGV0ZVJlbWluZGVyKGlkKXsKICB3b3Jrc3BhY2VzLmZvckVhY2god3M9PnsKICAgIGNvbnN0IHN1YnMgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVN1YnMod3MpKXx8J1tdJyk7CiAgICBbd3MsIC4uLnN1YnMubWFwKHM9PmAke3dzfTo6JHtzfWApXS5mb3JFYWNoKHBpZD0+ewogICAgICBjb25zdCBsaXN0ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlSZW1pbmRlcihwaWQpKXx8J1tdJyk7CiAgICAgIGNvbnN0IG5leHQgPSBsaXN0LmZpbHRlcih4PT54LmlkIT09aWQpOwogICAgICBpZihuZXh0Lmxlbmd0aCE9PWxpc3QubGVuZ3RoKSBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXlSZW1pbmRlcihwaWQpLCBKU09OLnN0cmluZ2lmeShuZXh0KSk7CiAgICB9KTsKICB9KTsKfQpmdW5jdGlvbiBtYXJrUmVtaW5kZXJGaXJlZChpZCl7IGRlbGV0ZVJlbWluZGVyKGlkKTsgfQoKLyogUmVtaW5kZXIgbW9kYWwgKi8KbGV0IHJlbW9kYWxUaW1lciA9IG51bGw7CmZ1bmN0aW9uIHNob3dSZW1pbmRlck1vZGFsKGVtb2ppLCBtc2cpewogIGVscy5yZW1vZGFsVGl0bGUudGV4dENvbnRlbnQgPSBgJHtlbW9qaX0gUmVtaW5kZXJgOwogIGVscy5yZW1vZGFsTXNnLnRleHRDb250ZW50ID0gbXNnOwogIGVscy5yZW1vZGFsLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTsKICBpZihyZW1vZGFsVGltZXIpIGNsZWFyVGltZW91dChyZW1vZGFsVGltZXIpOwogIHJlbW9kYWxUaW1lciA9IHNldFRpbWVvdXQoaGlkZVJlbWluZGVyTW9kYWwsIDYwMDAwKTsgLy8gYXV0by1oaWRlIGFmdGVyIDEgbWluCn0KZnVuY3Rpb24gaGlkZVJlbWluZGVyTW9kYWwoKXsKICBlbHMucmVtb2RhbC5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7CiAgaWYocmVtb2RhbFRpbWVyKXsgY2xlYXJUaW1lb3V0KHJlbW9kYWxUaW1lcik7IHJlbW9kYWxUaW1lcj1udWxsOyB9Cn0KZWxzLnJlbW9kYWxDbG9zZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhpZGVSZW1pbmRlck1vZGFsKTsKZWxzLnJlbW9kYWxEaXNtaXNzLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGlkZVJlbWluZGVyTW9kYWwpOwoKLyogPT09PT0gVXRpbHMgPT09PT0gKi8KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsKICBpZighZWxzLmRyYXdQb3BvdmVyLmNvbnRhaW5zKGUudGFyZ2V0KSAmJiBlLnRhcmdldCE9PWVscy5kcmF3VG9nZ2xlICYmIGRyYXdpbmdPbil7IGVscy5kcmF3UG9wb3Zlci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7IH0KfSk7CmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSk9PnsKICBpZihlLmtleT09PSdFc2NhcGUnKXsgY2xvc2VBbGxQb3BvdmVycygpOyBoaWRlUmVtaW5kZXJNb2RhbCgpOyB9Cn0pOwpmdW5jdGlvbiBzdHJpcEh0bWwocyl7IHJldHVybiAoc3x8JycpLnJlcGxhY2UoLzxbXj5dKz4vZywnJykudHJpbSgpOyB9"},{"t":"classic","d":"d2luZG93Ll9fanVtcFRvVG9wPWZ1bmN0aW9uKCl7dHJ5e3dpbmRvdy5zY3JvbGxUbyh7dG9wOjAsYmVoYXZpb3I6ImF1dG8ifSl9Y2F0Y2gobyl7fXRyeXtkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wPTB9Y2F0Y2gobyl7fXRyeXtkb2N1bWVudC5ib2R5LnNjcm9sbFRvcD0wfWNhdGNoKG8pe310cnl7dmFyIG89ZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLm1haW4iKTtvJiYoby5zY3JvbGxUb3A9MCl9Y2F0Y2gobyl7fXRyeXt2YXIgdD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZWRpdG9yIik7dCYmKHQuc2Nyb2xsVG9wPTApfWNhdGNoKG8pe310cnl7dmFyIGM9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBhZ2VUb3AiKTtjJiZjLnNjcm9sbEludG9WaWV3JiZjLnNjcm9sbEludG9WaWV3KHtiZWhhdmlvcjoiYXV0byIsYmxvY2s6InN0YXJ0In0pfWNhdGNoKG8pe31yZXR1cm4hMX0="},{"t":"classic","d":"Ly8gPT09IFJvYnVzdCBUaXRsZSBFZGl0b3IgKHN3YXAtdG8taW5wdXQpIOKAlCBzaW5nbGUgc291cmNlIG9mIHRydXRoIHBlciB3b3Jrc3BhY2UgPT09CihmdW5jdGlvbigpewogIGNvbnN0IHRpdGxlV3JhcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHBUaXRsZScpOwogIGNvbnN0IHRpdGxlVGV4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHBUaXRsZVRleHQnKTsKICBjb25zdCB0aXRsZUlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcFRpdGxlSW5wdXQnKTsKCiAgZnVuY3Rpb24gbm9ybShzKXsgcmV0dXJuIChzfHwnJykucmVwbGFjZSgvXHMrL2csJyAnKS50cmltKCk7IH0KICBmdW5jdGlvbiBrZXlGb3Iod3MpeyB0cnkgeyByZXR1cm4ga2V5VGl0bGUod3MpOyB9IGNhdGNoIHsgcmV0dXJuICdxdWlja25vdGVzLXRpdGxlLScrd3M7IH0gfQogIGZ1bmN0aW9uIGN1cnJlbnROYW1lKCl7CiAgICB0cnkgewogICAgICBjb25zdCBzdG9yZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXlGb3IoY3VycmVudFdvcmtzcGFjZSkpOwogICAgICByZXR1cm4gKHN0b3JlZCAmJiBzdG9yZWQudHJpbSgpKSA/IHN0b3JlZCA6IChjdXJyZW50V29ya3NwYWNlfHwnJykuc3BsaXQoJzo6JykucG9wKCk7CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIChjdXJyZW50V29ya3NwYWNlfHwnJykuc3BsaXQoJzo6JykucG9wKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNldEV2ZXJ5d2hlcmUobmFtZSl7CiAgICBjb25zdCB2ID0gbm9ybShuYW1lKTsKICAgIHRyeSB7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleUZvcihjdXJyZW50V29ya3NwYWNlKSwgdik7IH0gY2F0Y2gge30KICAgIHRyeSB7IGRvY3VtZW50LnRpdGxlID0gdiA/ICh2ICsgJyDigJQgUmFtTm90ZXMnKSA6ICdSYW1Ob3Rlcyc7IH0gY2F0Y2gge30KICAgIC8vIGhlYWRlciB0ZXh0CiAgICBpZiAodGl0bGVUZXh0KSB0aXRsZVRleHQudGV4dENvbnRlbnQgPSB2OwogICAgLy8gc21hbGwgd29ya3NwYWNlIHRpdGxlIGluIHBhZ2UKICAgIHRyeSB7IGlmIChlbHMgJiYgZWxzLnRpdGxlKSBlbHMudGl0bGUudGV4dENvbnRlbnQgPSB2OyB9IGNhdGNoIHt9CiAgICAvLyByZS1yZW5kZXIgc2lkZWJhciBsaXN0CiAgICB0cnkgeyBpZiAodHlwZW9mIHJlbmRlcldvcmtzcGFjZXM9PT0nZnVuY3Rpb24nKSByZW5kZXJXb3Jrc3BhY2VzKCk7IH0gY2F0Y2gge30KICB9CiAgZnVuY3Rpb24gcmVmcmVzaEZyb21TdG9yYWdlKCl7CiAgICBjb25zdCB2ID0gY3VycmVudE5hbWUoKTsKICAgIGlmICh0aXRsZVRleHQpIHRpdGxlVGV4dC50ZXh0Q29udGVudCA9IHY7CiAgICB0cnkgeyBpZiAoZWxzICYmIGVscy50aXRsZSkgZWxzLnRpdGxlLnRleHRDb250ZW50ID0gdjsgfSBjYXRjaCB7fQogIH0KCiAgLy8gU3RhcnQgd2l0aCBzdG9yYWdlIHZhbHVlCiAgcmVmcmVzaEZyb21TdG9yYWdlKCk7CgogIC8vIENsaWNraW5nIHRoZSB0aXRsZSB0dXJucyBpdCBpbnRvIGFuIGlucHV0CiAgaWYgKHRpdGxlV3JhcCAmJiB0aXRsZVRleHQgJiYgdGl0bGVJbnB1dCkgewogICAgdGl0bGVXcmFwLnN0eWxlLmN1cnNvciA9ICd0ZXh0JzsKICAgIHRpdGxlV3JhcC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+ewogICAgICAvLyBvbmx5IHN3YXAgaWYgY2xpY2tpbmcgdGV4dCwgbm90IHdoZW4gYWxyZWFkeSBlZGl0aW5nCiAgICAgIGlmICh0aXRsZUlucHV0LnN0eWxlLmRpc3BsYXkgPT09ICdub25lJykgewogICAgICAgIHRpdGxlSW5wdXQudmFsdWUgPSBjdXJyZW50TmFtZSgpOwogICAgICAgIHRpdGxlVGV4dC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIHRpdGxlSW5wdXQuc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUtYmxvY2snOwogICAgICAgIC8vIEZvY3VzIGFmdGVyIHBhaW50CiAgICAgICAgc2V0VGltZW91dCgoKT0+eyB0cnkgeyB0aXRsZUlucHV0LmZvY3VzKCk7IHRpdGxlSW5wdXQuc2VsZWN0KCk7IH0gY2F0Y2gge30gfSwgMCk7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIFNhdmUgb24gRW50ZXIvYmx1ciwgY2FuY2VsIG9uIEVzY2FwZQogICAgdGl0bGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57CiAgICAgIGlmIChlLmtleSA9PT0gJ0VudGVyJykgeyBlLnByZXZlbnREZWZhdWx0KCk7IHRpdGxlSW5wdXQuYmx1cigpOyB9CiAgICAgIGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdGl0bGVJbnB1dC52YWx1ZSA9IGN1cnJlbnROYW1lKCk7CiAgICAgICAgdGl0bGVJbnB1dC5ibHVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgdGl0bGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgKCk9PnsKICAgICAgc2V0RXZlcnl3aGVyZSh0aXRsZUlucHV0LnZhbHVlKTsKICAgICAgdGl0bGVJbnB1dC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB0aXRsZVRleHQuc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUnOwogICAgfSk7CiAgfQoKICAvLyBLZWVwIGhlYWRlciBzeW5jZWQgd2hlbmV2ZXIgbm90ZXMvd29ya3NwYWNlcyBjaGFuZ2UKICBmdW5jdGlvbiBwYXRjaChmbk5hbWUpewogICAgdHJ5ewogICAgICBpZiAodHlwZW9mIHdpbmRvd1tmbk5hbWVdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY29uc3Qgb2xkID0gd2luZG93W2ZuTmFtZV07CiAgICAgICAgd2luZG93W2ZuTmFtZV0gPSBmdW5jdGlvbigpewogICAgICAgICAgY29uc3QgciA9IG9sZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmVmcmVzaEZyb21TdG9yYWdlKCk7CiAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9CiAgICAgIH0KICAgIH1jYXRjaHt9CiAgfQogIHBhdGNoKCdsb2FkTm90ZScpOwogIHBhdGNoKCdzd2l0Y2hXb3Jrc3BhY2UnKTsKCiAgLy8gQXMgYSBmYWxsYmFjaywgYWxzbyByZWZyZXNoIG9uIHBhZ2UgbG9hZAogIHRyeSB7IHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgcmVmcmVzaEZyb21TdG9yYWdlKTsgfSBjYXRjaCB7fQp9KSgpOw=="},{"t":"classic","d":"LyogLS0tIEluc3RhbnQgdGFiIHRpdGxlIGZyb20gd29ya3NwYWNlIHRpdGxlIC0tLSAqLwooZnVuY3Rpb24oKXsKICB2YXIgd3NUaXRsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3b3Jrc3BhY2VUaXRsZScpIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHBUaXRsZScpIHx8IG51bGw7CiAgZnVuY3Rpb24gbm9ybShzKXsgcmV0dXJuIChzfHwnJykucmVwbGFjZSgvXHMrL2csJyAnKS50cmltKCk7IH0KICBmdW5jdGlvbiBzZXRUYWIoKXsKICAgIGlmKCF3c1RpdGxlKSByZXR1cm47CiAgICB2YXIgdCA9IG5vcm0od3NUaXRsZS50ZXh0Q29udGVudCB8fCB3c1RpdGxlLnZhbHVlIHx8IHdzVGl0bGUuaW5uZXJUZXh0IHx8ICcnKTsKICAgIGRvY3VtZW50LnRpdGxlID0gKHQgPyB0IDogJ1VudGl0bGVkJykgKyAnIC0gUmFtTm90ZXMnOwogIH0KICBpZih3c1RpdGxlKXsKICAgIHdzVGl0bGUuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBzZXRUYWIpOwogICAgd3NUaXRsZS5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgc2V0VGFiKTsKICAgIHNldFRhYigpOwogIH0KICBpZih0eXBlb2Ygd2luZG93LmxvYWROb3RlPT09J2Z1bmN0aW9uJyl7CiAgICB2YXIgX19sbiA9IHdpbmRvdy5sb2FkTm90ZTsKICAgIHdpbmRvdy5sb2FkTm90ZSA9IGZ1bmN0aW9uKCl7IF9fbG4oKTsgc2V0VGltZW91dChzZXRUYWIsIDApOyB9OwogIH0KICBpZih0eXBlb2Ygd2luZG93LnN3aXRjaFdvcmtzcGFjZT09PSdmdW5jdGlvbicpewogICAgdmFyIF9fc3cgPSB3aW5kb3cuc3dpdGNoV29ya3NwYWNlOwogICAgd2luZG93LnN3aXRjaFdvcmtzcGFjZSA9IGZ1bmN0aW9uKGlkKXsgX19zdyhpZCk7IHNldFRpbWVvdXQoc2V0VGFiLCAwKTsgfTsKICB9Cn0pKCk7CgovKiAtLS0gSW1hZ2UgcGFzdGUvZHJhZyArIGNsaWNrLXRvLXJlc2l6ZSAobWluaW1hbCBVSSkgLS0tICovCihmdW5jdGlvbigpewogIHZhciBlZGl0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZWRpdG9yJyk7CiAgaWYoIWVkaXRvcikgcmV0dXJuOwoKICB2YXIgdWkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICB1aS5pZCA9ICdpbWdDb250cm9scyc7CiAgdWkuc3R5bGUuY3NzVGV4dCA9ICdwb3NpdGlvbjpmaXhlZDtkaXNwbGF5Om5vbmU7ei1pbmRleDo0MDAwO2JhY2tncm91bmQ6dmFyKC0tYmcpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tc3VyZmFjZS0yKTtib3JkZXItcmFkaXVzOjEwcHg7cGFkZGluZzo4cHggMTBweDtib3gtc2hhZG93OjAgMTBweCAyNHB4IHJnYmEoMCwwLDAsLjI4KSc7CiAgdWkuaW5uZXJIVE1MID0gJzxsYWJlbCBzdHlsZT0iZm9udC1zaXplOi44NXJlbTtvcGFjaXR5Oi45O2Rpc3BsYXk6YmxvY2s7bWFyZ2luLWJvdHRvbTo2cHgiPkltYWdlIHNpemU8L2xhYmVsPjxpbnB1dCBpZD0iaW1nU2l6ZSIgdHlwZT0icmFuZ2UiIG1pbj0iMTAiIG1heD0iMTAwIiB2YWx1ZT0iNjAiIHN0eWxlPSJ3aWR0aDoyMDBweCI+JzsKICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHVpKTsKICB2YXIgaW1nU2l6ZSA9IHVpLnF1ZXJ5U2VsZWN0b3IoJyNpbWdTaXplJyk7CiAgdmFyIHNlbGVjdGVkID0gbnVsbDsKCiAgZnVuY3Rpb24gc2hvd0ZvcihpbWcpewogICAgc2VsZWN0ZWQgPSBpbWc7CiAgICB2YXIgcmVjdCA9IGltZy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIGltZ1NpemUudmFsdWUgPSBNYXRoLm1heCgxMCwgTWF0aC5taW4oMTAwLCBNYXRoLnJvdW5kKCAocmVjdC53aWR0aC8oaW1nLnBhcmVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGh8fDEpKSoxMDAgKSkpOwogICAgdWkuc3R5bGUubGVmdCA9IChyZWN0LmxlZnQgKyB3aW5kb3cuc2Nyb2xsWCkgKyAncHgnOwogICAgdWkuc3R5bGUudG9wICA9IChyZWN0LnRvcCArIHdpbmRvdy5zY3JvbGxZIC0gdWkub2Zmc2V0SGVpZ2h0IC0gOCkgKyAncHgnOwogICAgdWkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgfQogIGZ1bmN0aW9uIGhpZGUoKXsgdWkuc3R5bGUuZGlzcGxheT0nbm9uZSc7IHNlbGVjdGVkPW51bGw7IH0KCiAgaW1nU2l6ZS5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIGZ1bmN0aW9uKCl7CiAgICBpZighc2VsZWN0ZWQpIHJldHVybjsKICAgIHNlbGVjdGVkLnN0eWxlLndpZHRoID0gaW1nU2l6ZS52YWx1ZSArICclJzsKICAgIGlmKHR5cGVvZiBzYXZlU29vbj09PSdmdW5jdGlvbicpIHNhdmVTb29uKCk7CiAgfSk7CiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKXsKICAgIHZhciBpbWcgPSBlLnRhcmdldCAmJiBlLnRhcmdldC50YWdOYW1lPT09J0lNRycgJiYgZWRpdG9yLmNvbnRhaW5zKGUudGFyZ2V0KSA/IGUudGFyZ2V0IDogbnVsbDsKICAgIGlmKGltZykgc2hvd0ZvcihpbWcpOwogICAgZWxzZSBpZighdWkuY29udGFpbnMoZS50YXJnZXQpKSBoaWRlKCk7CiAgfSk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGZ1bmN0aW9uKCl7IGlmKHNlbGVjdGVkKSBzaG93Rm9yKHNlbGVjdGVkKTsgfSk7CgogIGZ1bmN0aW9uIGluc2VydEJsb2IoYmxvYil7CiAgICB2YXIgciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICByLm9ubG9hZCA9IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgICAgaW1nLnNyYyA9IHIucmVzdWx0OyBpbWcuYWx0PSdpbWFnZSc7IGltZy5zdHlsZS53aWR0aD0nNjAlJzsgaW1nLnN0eWxlLmhlaWdodD0nYXV0byc7CiAgICAgIHZhciBzZWwgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgICAgIGlmKHNlbCAmJiBzZWwucmFuZ2VDb3VudCl7CiAgICAgICAgdmFyIHJhbmdlID0gc2VsLmdldFJhbmdlQXQoMCk7IHJhbmdlLmNvbGxhcHNlKGZhbHNlKTsgcmFuZ2UuaW5zZXJ0Tm9kZShpbWcpOwogICAgICB9IGVsc2UgZWRpdG9yLmFwcGVuZENoaWxkKGltZyk7CiAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICBpZih0eXBlb2Ygc2F2ZVNvb249PT0nZnVuY3Rpb24nKSBzYXZlU29vbigpOwogICAgICBzaG93Rm9yKGltZyk7CiAgICB9OwogICAgci5yZWFkQXNEYXRhVVJMKGJsb2IpOwogIH0KCiAgZWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoJ3Bhc3RlJywgZnVuY3Rpb24oZSl7CiAgICB2YXIgaXRlbXMgPSAoZS5jbGlwYm9hcmREYXRhICYmIGUuY2xpcGJvYXJkRGF0YS5pdGVtcykgfHwgW107CiAgICBmb3IodmFyIGk9MDtpPGl0ZW1zLmxlbmd0aDtpKyspewogICAgICB2YXIgaXQgPSBpdGVtc1tpXTsKICAgICAgaWYoaXQua2luZD09PSdmaWxlJyAmJiBpdC50eXBlLmluZGV4T2YoJ2ltYWdlLycpPT09MCl7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOyB2YXIgZmlsZSA9IGl0LmdldEFzRmlsZSgpOyBpZihmaWxlKSBpbnNlcnRCbG9iKGZpbGUpOyByZXR1cm47CiAgICAgIH0KICAgIH0KICB9KTsKICBlZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIGZ1bmN0aW9uKGUpewogICAgdmFyIGZpbGVzID0gZS5kYXRhVHJhbnNmZXIgJiYgZS5kYXRhVHJhbnNmZXIuZmlsZXM7IGlmKCFmaWxlcyB8fCAhZmlsZXMubGVuZ3RoKSByZXR1cm47CiAgICB2YXIgaGFuZGxlZCA9IEZhbHNlOwogICAgZm9yKHZhciBpPTA7aTxmaWxlcy5sZW5ndGg7aSsrKXsKICAgICAgdmFyIGYgPSBmaWxlc1tpXTsKICAgICAgaWYoZi50eXBlICYmIGYudHlwZS5pbmRleE9mKCdpbWFnZS8nKT09PTApeyBpbnNlcnRCbG9iKGYpOyBoYW5kbGVkID0gdHJ1ZTsgfQogICAgfQogICAgaWYoaGFuZGxlZCkgZS5wcmV2ZW50RGVmYXVsdCgpOwogIH0pOwp9KSgpOwoKLyogLS0tIENvbmZpZyBJbXBvcnQvRXhwb3J0IC0tLSAqLwooZnVuY3Rpb24oKXsKICB2YXIgZXhwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NmZ0V4cG9ydCcpOwogIHZhciBpbXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2ZnSW1wb3J0Jyk7CiAgaWYoZXhwKXsKICAgIGV4cC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCl7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGZvcih2YXIgaT0wO2k8bG9jYWxTdG9yYWdlLmxlbmd0aDtpKyspewogICAgICAgIHZhciBrID0gbG9jYWxTdG9yYWdlLmtleShpKTsKICAgICAgICBpZigvXnF1aWNrbm90ZXMtfF5yYW1ub3Rlcy0vLnRlc3QoaykpIGRhdGFba10gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrKTsKICAgICAgfQogICAgICB2YXIgYmxvYiA9IG5ldyBCbG9iKFtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsMildLCB7dHlwZTonYXBwbGljYXRpb24vanNvbid9KTsKICAgICAgdmFyIHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOyBhLmhyZWYgPSB1cmw7IGEuZG93bmxvYWQgPSAnUmFtTm90ZXNDb25maWcuanNvbic7IGEuY2xpY2soKTsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpeyBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7IH0sIDUwMCk7CiAgICB9KTsKICB9CiAgaWYoaW1wKXsKICAgIGltcC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jIGZ1bmN0aW9uKCl7CiAgICAgIHRyeXsKICAgICAgICBpZih3aW5kb3cuc2hvd09wZW5GaWxlUGlja2VyKXsKICAgICAgICAgIGNvbnN0IFtoXSA9IGF3YWl0IHdpbmRvdy5zaG93T3BlbkZpbGVQaWNrZXIoe3R5cGVzOlt7ZGVzY3JpcHRpb246J1JhbU5vdGVzIENvbmZpZycsIGFjY2VwdDp7J2FwcGxpY2F0aW9uL2pzb24nOlsnLmpzb24nXX19XX0pOwogICAgICAgICAgY29uc3QgZiA9IGF3YWl0IGguZ2V0RmlsZSgpOyBjb25zdCB0eHQgPSBhd2FpdCBmLnRleHQoKTsgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UodHh0IHx8ICd7fScpOwogICAgICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChmdW5jdGlvbihrKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oaywgZGF0YVtrXSk7IH0pOwogICAgICAgICAgYWxlcnQoJ0NvbmZpZyBpbXBvcnRlZC4gUmVsb2FkaW5n4oCmJyk7IGxvY2F0aW9uLnJlbG9hZCgpOwogICAgICAgIH1lbHNlewogICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsgaW5wdXQudHlwZT0nZmlsZSc7IGlucHV0LmFjY2VwdD0nLmpzb24sYXBwbGljYXRpb24vanNvbic7CiAgICAgICAgICBpbnB1dC5vbmNoYW5nZSA9IGFzeW5jIGZ1bmN0aW9uKCl7IGNvbnN0IGYgPSBpbnB1dC5maWxlc1swXTsgY29uc3QgdHh0ID0gYXdhaXQgZi50ZXh0KCk7IGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHR4dHx8J3t9Jyk7IE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goaz0+bG9jYWxTdG9yYWdlLnNldEl0ZW0oayxkYXRhW2tdKSk7IGFsZXJ0KCdDb25maWcgaW1wb3J0ZWQuIFJlbG9hZGluZ+KApicpOyBsb2NhdGlvbi5yZWxvYWQoKTsgfTsKICAgICAgICAgIGlucHV0LmNsaWNrKCk7CiAgICAgICAgfQogICAgICB9Y2F0Y2goZSl7IGFsZXJ0KCdDb3VsZCBub3QgaW1wb3J0IGNvbmZpZy4nKTsgfQogICAgfSk7CiAgfQp9KSgpOwoKLyogLS0tIFJvYnVzdCBUb3AgYnV0dG9uIC0tLSAqLwooZnVuY3Rpb24oKXsKICB2YXIgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Njcm9sbFRvcEJ0bicpOwogIGZ1bmN0aW9uIGp1bXAoKXsKICAgIHRyeXsgd2luZG93LnNjcm9sbFRvKHt0b3A6MCwgYmVoYXZpb3I6J2F1dG8nfSk7IH1jYXRjaHt9CiAgICB0cnl7IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgPSAwOyB9Y2F0Y2h7fQogICAgdHJ5eyBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCA9IDA7IH1jYXRjaHt9CiAgICB2YXIgZWRpdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VkaXRvcicpOwogICAgaWYoZWRpdG9yKXsgdHJ5eyBlZGl0b3Iuc2Nyb2xsVG9wID0gMDsgfWNhdGNoe30gfQogIH0KICBpZihidG4peyBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyBqdW1wKCk7IH0pOyB9Cn0pKCk7"},{"t":"classic","d":"LyogLS0tIER1YWwgSGVhZGVyIE1lbnVzIChsZWZ0L3JpZ2h0KSAtLS0gKi8KKGZ1bmN0aW9uKCl7CiAgZnVuY3Rpb24gYnVpbGRNZW51KGJ0bklkLCBwYW5lbElkLCBjb250ZW50SWQsIGlkcyl7CiAgICB2YXIgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYnRuSWQpOwogICAgdmFyIHBhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocGFuZWxJZCk7CiAgICB2YXIgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRlbnRJZCk7CiAgICBpZighYnRuIHx8ICFwYW5lbCB8fCAhY29udGVudCkgcmV0dXJuOwoKICAgIGZ1bmN0aW9uIG1ha2VQcm94eShlbCl7CiAgICAgIGlmKCFlbCkgcmV0dXJuIG51bGw7CiAgICAgIGlmKGVsLnRhZ05hbWUgPT09ICdTRUxFQ1QnKXsKICAgICAgICB2YXIgc2J0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwogICAgICAgIHNidG4uY2xhc3NOYW1lID0gJ2J0bic7CiAgICAgICAgLy8gVHJ5IHRvIGtlZXAgbGFiZWwgY2xvc2UgdG8geW91ciBleGlzdGluZyBTdHlsZXMgdGV4dAogICAgICAgIHNidG4udGV4dENvbnRlbnQgPSBlbC50aXRsZSB8fCAnU3R5bGVzJzsKICAgICAgICBzYnRuLm9uY2xpY2sgPSBmdW5jdGlvbigpeyB0cnl7IGVsLmZvY3VzKCk7IGVsLmNsaWNrICYmIGVsLmNsaWNrKCk7IH1jYXRjaHt9IHBhbmVsLnN0eWxlLmRpc3BsYXk9J25vbmUnOyB9OwogICAgICAgIHJldHVybiBzYnRuOwogICAgICB9CiAgICAgIHZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7CiAgICAgIGIuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lIHx8ICdidG4nOwogICAgICB2YXIgbGFiZWwgPSAoZWwudGV4dENvbnRlbnQgfHwgZWwudGl0bGUgfHwgZWwuaWQgfHwgJ0FjdGlvbicpLnRyaW0oKTsKICAgICAgYi50ZXh0Q29udGVudCA9IGxhYmVsOwogICAgICBiLm9uY2xpY2sgPSBmdW5jdGlvbihlKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyB0cnl7IGVsLmNsaWNrKCk7IH1jYXRjaHt9IHBhbmVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IH07CiAgICAgIHJldHVybiBiOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlYnVpbGQoKXsKICAgICAgY29udGVudC5pbm5lckhUTUwgPSAnJzsKICAgICAgaWRzLmZvckVhY2goZnVuY3Rpb24oaWQpewogICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICB2YXIgcHJveHkgPSBtYWtlUHJveHkoZWwpOwogICAgICAgIGlmKHByb3h5KSBjb250ZW50LmFwcGVuZENoaWxkKHByb3h5KTsKICAgICAgfSk7CiAgICB9CgogICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgLy8gdG9nZ2xlCiAgICAgIGlmKHBhbmVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyB8fCBwYW5lbC5zdHlsZS5kaXNwbGF5ID09PSAnJyl7CiAgICAgICAgcmVidWlsZCgpOwogICAgICAgIHBhbmVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICB9ZWxzZXsKICAgICAgICBwYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB9CiAgICB9KTsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpewogICAgICBpZihlLnRhcmdldCA9PT0gYnRuKSByZXR1cm47CiAgICAgIGlmKHBhbmVsLmNvbnRhaW5zKGUudGFyZ2V0KSkgcmV0dXJuOwogICAgICBwYW5lbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgfSk7CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGZ1bmN0aW9uKCl7IGlmKHBhbmVsLnN0eWxlLmRpc3BsYXk9PT0nYmxvY2snKXsgLyogc3RheXMgZG9ja2VkICovIH0gfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgZnVuY3Rpb24oKXsgaWYocGFuZWwuc3R5bGUuZGlzcGxheT09PSdibG9jaycpeyAvKiBzdGF5cyBkb2NrZWQgKi8gfSB9KTsKICB9CgogIC8vIExlZnQgc2lkZSBhY3Rpb25zOiB5b3VyIG9yaWdpbmFsIGxlZnQgY2x1c3RlcgogIGJ1aWxkTWVudSgnbGVmdE1lbnVCdG4nLCdsZWZ0TWVudVBhbmVsJywnbGVmdE1lbnVDb250ZW50JyxbCiAgICAncmVtaW5kZXJCdG4nLCdkZWxldGVQYWdlJywndG9nZ2xlVG9vbGJhcicsJ2Rvd25sb2FkQnRuJywncmV2ZXJ0QnRuJywnZHJhd1RvZ2dsZScKICBdKTsKICAvLyBSaWdodCBzaWRlIGFjdGlvbnM6IHlvdXIgb3JpZ2luYWwgcmlnaHQgY2x1c3RlciArIGNvbmZpZyBjb250cm9scwogIGJ1aWxkTWVudSgncmlnaHRNZW51QnRuJywncmlnaHRNZW51UGFuZWwnLCdyaWdodE1lbnVDb250ZW50JyxbCiAgICAnZW1haWxCdG4nLCdzY3JvbGxUb3BCdG4nLCdzdHlsZVNlbGVjdG9yJywnY2ZnRXhwb3J0JywnY2ZnSW1wb3J0JwogIF0pOwp9KSgpOw=="},{"t":"classic","d":"IWZ1bmN0aW9uKCl7dmFyIGE9InJhbW5vdGVzLnNlZW5XZWxjb21lIixyPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJlZGl0b3IiKTtpZihyKXt2YXIgaT0nPGRpdiBpZD0id2VsY29tZUJsb2NrIiBkYXRhLXJhbW5vdGVzLXdlbGNvbWU9IjEiIHN0eWxlPSJib3JkZXI6MXB4IGRhc2hlZCB2YXIoLS1zdXJmYWNlLTIsICMzYTQpOyBwYWRkaW5nOjE2cHg7IGJvcmRlci1yYWRpdXM6MTJweDsgbWFyZ2luOjhweCAwOyBiYWNrZ3JvdW5kOnJnYmEoMjU1LDI1NSwyNTUsMC4wMykiPjxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxLjE1cmVtOyBtYXJnaW4tYm90dG9tOjhweCI+8J+MnyA8Yj5XZWxjb21lIHRvIFJhbU5vdGVzITwvYj48L2Rpdj48ZGl2PkV2ZXJ5IGJpZyBpZGVhIHN0YXJ0cyBhcyBhIHNtYWxsIG5vdGUuPGJyPlRoaXMgaXMgeW91ciBwZXJzb25hbCBodWIgZm9yIGNhcHR1cmluZyBzcGFya3Mgb2YgY3JlYXRpdml0eSw8YnI+b3JnYW5pemluZyBwcm9qZWN0cywgYW5kIGJ1aWxkaW5nIHNvbWV0aGluZyBhd2Vzb21lLiDwn5qAPC9kaXY+PGRpdiBzdHlsZT0ib3BhY2l0eTouNzU7IG1hcmdpbi10b3A6MTBweDsgZm9udC1zaXplOi45NXJlbTsiPlRpcDogZGVsZXRlIHRoaXMgbWVzc2FnZSB3aGVuIHlvdVwncmUgcmVhZHnigJRvbmNlIHJlbW92ZWQsIGl0IHdvblwndCBjb21lIGJhY2suPC9kaXY+PC9kaXY+JztpZihkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIixmdW5jdGlvbigpe3NldFRpbWVvdXQoZnVuY3Rpb24oKXtvKCksbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24oKXtkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsY29tZUJsb2NrIil8fGxvY2FsU3RvcmFnZS5zZXRJdGVtKGEsIjEiKX0pLm9ic2VydmUocix7Y2hpbGRMaXN0OiEwLHN1YnRyZWU6ITB9KX0sMCl9KSwiZnVuY3Rpb24iPT10eXBlb2Ygd2luZG93LmxvYWRQYWdlKXt2YXIgdD13aW5kb3cubG9hZFBhZ2U7d2luZG93LmxvYWRQYWdlPWZ1bmN0aW9uKGUpe3QoZSksc2V0VGltZW91dChvLDApfX1pZigiZnVuY3Rpb24iPT10eXBlb2Ygd2luZG93LmxvYWROb3RlKXt2YXIgZT13aW5kb3cubG9hZE5vdGU7d2luZG93LmxvYWROb3RlPWZ1bmN0aW9uKCl7ZSgpLHNldFRpbWVvdXQobywwKX19fWZ1bmN0aW9uIG8oKXtpZigiMSIhPT1sb2NhbFN0b3JhZ2UuZ2V0SXRlbShhKSl7dmFyIGU9bG9jYWxTdG9yYWdlLmdldEl0ZW0oInJhbW5vdGVzLmN1cnJlbnQiKXx8bG9jYWxTdG9yYWdlLmdldEl0ZW0oInJhbW5vdGVzLnNldHRpbmcuY3VycmVudFBhZ2UiKXx8IiIsdD1lP2xvY2FsU3RvcmFnZS5nZXRJdGVtKCJyYW1ub3Rlcy5wYWdlLiIrZSk6bnVsbCxvPW51bGw7dHJ5e289dD9KU09OLnBhcnNlKHQpOm51bGx9Y2F0Y2goZSl7bz1udWxsfXZhciBuPSExO2lmKCFmdW5jdGlvbigpe2Zvcih2YXIgZT0wO2U8bG9jYWxTdG9yYWdlLmxlbmd0aDtlKyspe3ZhciB0PWxvY2FsU3RvcmFnZS5rZXkoZSk7aWYodCYmdC5zdGFydHNXaXRoKCJyYW1ub3Rlcy5wYWdlLiIpKXJldHVybiEwfXJldHVybiExfSgpP249ITA6IW98fG8uaHRtbCYmby5odG1sLnRyaW0oKXx8KG49ITApLG4pe3IuaW5uZXJIVE1MJiZyLmlubmVySFRNTC50cmltKCk/LTE9PT1yLmlubmVySFRNTC5pbmRleE9mKCdpZD0id2VsY29tZUJsb2NrIicpJiZyLmluc2VydEFkamFjZW50SFRNTCgiYWZ0ZXJiZWdpbiIsaSk6ci5pbm5lckhUTUw9aTt0cnl7byYmKG8uaHRtbD1yLmlubmVySFRNTCxsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgicmFtbm90ZXMucGFnZS4iK2UsSlNPTi5zdHJpbmdpZnkobykpKX1jYXRjaChlKXt9fX19fSgp"},{"t":"classic","d":"KGZ1bmN0aW9uKCl7CiAgY29uc3QgJCA9IChzLGQ9ZG9jdW1lbnQpPT5kLnF1ZXJ5U2VsZWN0b3Iocyk7CiAgY29uc3QgJCQgPSAocyxkPWRvY3VtZW50KT0+QXJyYXkuZnJvbShkLnF1ZXJ5U2VsZWN0b3JBbGwocykpOwogIGZ1bmN0aW9uIHJlYWR5KGZuKXsgaWYoZG9jdW1lbnQucmVhZHlTdGF0ZSE9PSdsb2FkaW5nJykgZm4oKTsgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZm4pOyB9CgogIHJlYWR5KGZ1bmN0aW9uKCl7CiAgICAvKiBBcnJvd3MgKi8KICAgIGZ1bmN0aW9uIGF0dGFjaEFycm93cygpewogICAgICBjb25zdCBsaXN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dvcmtzcGFjZUxpc3QnKTsgaWYoIWxpc3QpIHJldHVybjsKICAgICAgY29uc3Qgcm93cyA9ICQkKCcud29ya3NwYWNlJywgbGlzdCk7CiAgICAgIHJvd3MuZm9yRWFjaCgocm93KT0+ewogICAgICAgIGNvbnN0IGhlYWRlciA9IHJvdy5xdWVyeVNlbGVjdG9yKCcud29ya3NwYWNlLWhlYWRlcicpOyBpZighaGVhZGVyKSByZXR1cm47CiAgICAgICAgaWYoaGVhZGVyLnF1ZXJ5U2VsZWN0b3IoJy5ybi1hcnJvdycpKSByZXR1cm47CiAgICAgICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsgd3JhcC5zdHlsZS5kaXNwbGF5PSdpbmxpbmUtZmxleCc7IHdyYXAuc3R5bGUubWFyZ2luTGVmdD0nNnB4JzsKICAgICAgICBjb25zdCB1cCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOyB1cC5jbGFzc05hbWU9J3JuLWFycm93JzsgdXAudGl0bGU9J01vdmUgdXAnOyB1cC5pbm5lckhUTUw9JyYjOTY1MDsnOwogICAgICAgIGNvbnN0IGRvd24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTsgZG93bi5jbGFzc05hbWU9J3JuLWFycm93JzsgZG93bi50aXRsZT0nTW92ZSBkb3duJzsgZG93bi5pbm5lckhUTUw9JyYjOTY2MDsnOwogICAgICAgIHdyYXAuYXBwZW5kKHVwLGRvd24pOyBoZWFkZXIuYXBwZW5kQ2hpbGQod3JhcCk7CiAgICAgICAgdXAuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgbW92ZVJvdyhyb3csLTEpOyB9KTsKICAgICAgICBkb3duLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGUuc3RvcFByb3BhZ2F0aW9uKCk7IG1vdmVSb3cocm93LCsxKTsgfSk7CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcGVyc2lzdEZyb21ET00oKXsKICAgICAgY29uc3QgbGlzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3b3Jrc3BhY2VMaXN0Jyk7IGlmKCFsaXN0KSByZXR1cm47CiAgICAgIGNvbnN0IHJvd3MgPSAkJCgnLndvcmtzcGFjZScsIGxpc3QpOwogICAgICBjb25zdCB3c0tleXMgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdxdWlja25vdGVzLXdvcmtzcGFjZXMnKXx8J1tdJyk7CiAgICAgIGNvbnN0IGtleUJ5VGl0bGU9e307IHdzS2V5cy5mb3JFYWNoKGs9PiBrZXlCeVRpdGxlWyhsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncXVpY2tub3Rlcy10aXRsZS0nK2spfHxrKS50cmltKCldID0gayk7CiAgICAgIGNvbnN0IG9yZGVyPVtdOyByb3dzLmZvckVhY2gocj0+eyBjb25zdCB0PShyLnF1ZXJ5U2VsZWN0b3IoJy53b3Jrc3BhY2UtaGVhZGVyIHNwYW4nKT8udGV4dENvbnRlbnR8fCcnKS50cmltKCk7IG9yZGVyLnB1c2goa2V5QnlUaXRsZVt0XXx8dCk7IH0pOwogICAgICBpZihvcmRlci5sZW5ndGgpewogICAgICAgIHRyeXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3F1aWNrbm90ZXMtd29ya3NwYWNlcycsIEpTT04uc3RyaW5naWZ5KG9yZGVyKSk7CiAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHdpbmRvdy53b3Jrc3BhY2VzKSl7IHdpbmRvdy53b3Jrc3BhY2VzLmxlbmd0aD0wOyBvcmRlci5mb3JFYWNoKHg9PndpbmRvdy53b3Jrc3BhY2VzLnB1c2goeCkpOyB9IH1jYXRjaHt9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG1vdmVSb3cocm93LCBkZWx0YSl7CiAgICAgIGNvbnN0IGxpc3QgPSByb3cucGFyZW50RWxlbWVudDsgaWYoIWxpc3QpIHJldHVybjsKICAgICAgaWYoZGVsdGE8MCl7IGNvbnN0IHByZXY9cm93LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7IGlmKHByZXYgJiYgcHJldi5jbGFzc0xpc3QuY29udGFpbnMoJ3dvcmtzcGFjZScpKSBsaXN0Lmluc2VydEJlZm9yZShyb3csIHByZXYpOyB9CiAgICAgIGVsc2UgeyBjb25zdCBuZXh0PXJvdy5uZXh0RWxlbWVudFNpYmxpbmc7IGlmKG5leHQgJiYgbmV4dC5jbGFzc0xpc3QuY29udGFpbnMoJ3dvcmtzcGFjZScpKSBsaXN0Lmluc2VydEJlZm9yZShuZXh0LCByb3cpOyB9CiAgICAgIHBlcnNpc3RGcm9tRE9NKCk7CiAgICB9CiAgICBjb25zdCB3c0xpc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd29ya3NwYWNlTGlzdCcpOwogICAgaWYodHlwZW9mIHdpbmRvdy5yZW5kZXJXb3Jrc3BhY2VzPT09J2Z1bmN0aW9uJyl7CiAgICAgIGNvbnN0IF9vcmlnID0gd2luZG93LnJlbmRlcldvcmtzcGFjZXM7CiAgICAgIHdpbmRvdy5yZW5kZXJXb3Jrc3BhY2VzID0gZnVuY3Rpb24oKXsgX29yaWcoKTsgYXR0YWNoQXJyb3dzKCk7IH07CiAgICB9CiAgICBpZih3c0xpc3QpeyBuZXcgTXV0YXRpb25PYnNlcnZlcigoKT0+YXR0YWNoQXJyb3dzKCkpLm9ic2VydmUod3NMaXN0LHtjaGlsZExpc3Q6dHJ1ZSwgc3VidHJlZTp0cnVlfSk7IH0KICAgIHNldFRpbWVvdXQoYXR0YWNoQXJyb3dzLCA2MCk7CgogICAgLyogU3R5bGVzICovCiAgICBjb25zdCBLRVk9J3JuX3RoZW1lX3YxMSc7CiAgICBjb25zdCBsZWdhY3k9WydyYW1ub3Rlcy10aGVtZS12OCcsJ3JhbW5vdGVzLXRoZW1lLXY3JywncmFtbm90ZXMtdGhlbWUtdjYnLCdyYW1ub3Rlcy10aGVtZS12NScsJ3JhbW5vdGVzLXRoZW1lJywncmFtbm90ZXNfdGhlbWVfdjInXTsKICAgIGZ1bmN0aW9uIG1pZ3JhdGUoKXsKICAgICAgdHJ5ewogICAgICAgIGZvcihjb25zdCBrIG9mIGxlZ2FjeSl7CiAgICAgICAgICBjb25zdCB2ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oayk7IGlmKCF2KSBjb250aW51ZTsKICAgICAgICAgIGNvbnN0IG1hcD17dGhpczonZGFyaycsIG5pZ2h0cmlkZTonZGFyayd9OyBjb25zdCBtID0gbWFwW3ZdfHx2OwogICAgICAgICAgaWYoWydsaWdodCcsJ2RhcmsnLCdvY2VhbicsJ2ZvcmVzdCcsJ2hhY2tlcicsJ25lb25iZXJyeSddLmluY2x1ZGVzKG0pKXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oS0VZLG0pOyByZXR1cm4gbTsgfQogICAgICAgIH0KICAgICAgfWNhdGNoe30KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBmdW5jdGlvbiBhcHBseVRoZW1lKG5hbWUpewogICAgICBjb25zdCBhbGxvd2VkPVsnbGlnaHQnLCdkYXJrJywnb2NlYW4nLCdmb3Jlc3QnLCdoYWNrZXInLCduZW9uYmVycnknXTsKICAgICAgaWYoIWFsbG93ZWQuaW5jbHVkZXMobmFtZSkpIG5hbWU9J2RhcmsnOwogICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ3RoZW1lLWxpZ2h0JywndGhlbWUtZGFyaycsJ3RoZW1lLW9jZWFuJywndGhlbWUtZm9yZXN0JywndGhlbWUtaGFja2VyJywndGhlbWUtbmVvbmJlcnJ5JywnbGlnaHQnLCdkYXJrJywnb2NlYW4nLCdmb3Jlc3QnLCdoYWNrZXInLCduZW9uYmVycnknLCd0aGlzJywnbmlnaHRyaWRlJyk7CiAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgndGhlbWUtJytuYW1lKTsgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKG5hbWUpOwogICAgICB0cnl7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKEtFWSxuYW1lKTsgfWNhdGNoe30KICAgIH0KICAgIChmdW5jdGlvbiBpbml0VGhlbWUoKXsKICAgICAgbGV0IHY9bnVsbDsgdHJ5eyB2ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oS0VZKTsgfWNhdGNoe307IGlmKCF2KSB2PW1pZ3JhdGUoKTsgaWYoIXYpIHY9J2RhcmsnOyBhcHBseVRoZW1lKHYpOwogICAgfSkoKTsKICAgIGZ1bmN0aW9uIGVuc3VyZVN0eWxlcygpewogICAgICBsZXQgYnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JuU3R5bGVzQnRuJyk7CiAgICAgIGlmKCFidG4pewogICAgICAgIGJ0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOyBidG4uaWQ9J3JuU3R5bGVzQnRuJzsgYnRuLnRleHRDb250ZW50PSfwn46oIFN0eWxlcyc7IGJ0bi5jbGFzc05hbWU9J2J0bic7CiAgICAgICAgY29uc3QgdG9vbGJhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b3AtYmFyIC5sZWZ0LWNvbnRyb2xzJykgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Rvb2xiYXInKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbGJhcicpOwogICAgICAgIGlmKHRvb2xiYXIpIHRvb2xiYXIuaW5zZXJ0QmVmb3JlKGJ0biwgdG9vbGJhci5maXJzdENoaWxkKTsgZWxzZSB7IGJ0bi5jbGFzc0xpc3QuYWRkKCdmbG9hdGluZycpOyBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGJ0bik7IH0KICAgICAgfQogICAgICBsZXQgbWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyblN0eWxlc01lbnUnKTsKICAgICAgaWYoIW1lbnUpewogICAgICAgIG1lbnUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgbWVudS5pZD0ncm5TdHlsZXNNZW51JzsKICAgICAgICBtZW51LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJncmlkIj4nCiAgICAgICAgICArJzxidXR0b24gY2xhc3M9ImNoaXAiIGRhdGEtdGhlbWU9ImRhcmsiPkRhcms8L2J1dHRvbj4nCiAgICAgICAgICArJzxidXR0b24gY2xhc3M9ImNoaXAiIGRhdGEtdGhlbWU9ImxpZ2h0Ij5MaWdodDwvYnV0dG9uPicKICAgICAgICAgICsnPGJ1dHRvbiBjbGFzcz0iY2hpcCIgZGF0YS10aGVtZT0ib2NlYW4iPk9jZWFuPC9idXR0b24+JwogICAgICAgICAgKyc8YnV0dG9uIGNsYXNzPSJjaGlwIiBkYXRhLXRoZW1lPSJmb3Jlc3QiPkZvcmVzdDwvYnV0dG9uPicKICAgICAgICAgICsnPGJ1dHRvbiBjbGFzcz0iY2hpcCIgZGF0YS10aGVtZT0iaGFja2VyIj5IYWNrZXI8L2J1dHRvbj4nCiAgICAgICAgICArJzxidXR0b24gY2xhc3M9ImNoaXAiIGRhdGEtdGhlbWU9Im5lb25iZXJyeSI+TmVvbkJlcnJ5PC9idXR0b24+JwogICAgICAgICAgKyc8L2Rpdj4nOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobWVudSk7CiAgICAgIH0KICAgICAgYnRuLm9uY2xpY2s9KGUpPT57IGUuc3RvcFByb3BhZ2F0aW9uKCk7IG1lbnUuY2xhc3NMaXN0LnRvZ2dsZSgnc2hvdycpOyB9OwogICAgICBtZW51LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywoZSk9PnsgY29uc3QgYj1lLnRhcmdldC5jbG9zZXN0KCcuY2hpcCcpOyBpZighYikgcmV0dXJuOyBhcHBseVRoZW1lKGIuZ2V0QXR0cmlidXRlKCdkYXRhLXRoZW1lJykpOyB9KTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IG1lbnUuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpKTsKICAgIH0KICAgIGVuc3VyZVN0eWxlcygpOwogICAgbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKCk9PnsgaWYoIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyblN0eWxlc0J0bicpKSBlbnN1cmVTdHlsZXMoKTsgfSkub2JzZXJ2ZShkb2N1bWVudC5ib2R5LHtjaGlsZExpc3Q6dHJ1ZSwgc3VidHJlZTp0cnVlfSk7CiAgfSk7Cn0pKCk7"}];
  var anchor = document.currentScript;
  function b64ToUtf8(b64){
    var bin = atob(b64);
    var bytes = new Uint8Array(bin.length);
    for (var i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    try { return new TextDecoder('utf-8').decode(bytes); }
    catch(e){ var s=''; for(var j=0;j<bytes.length;j++) s+=String.fromCharCode(bytes[j]); return decodeURIComponent(escape(s)); }
  }
  for (var i=0;i<list.length;i++){
    var it = list[i];
    var s = document.createElement('script');
    if (it.t === 'module') s.type = 'module';
    s.textContent = b64ToUtf8(it.d);
    anchor.parentNode.insertBefore(s, anchor);
  }
  anchor.remove();
})();
</script>
